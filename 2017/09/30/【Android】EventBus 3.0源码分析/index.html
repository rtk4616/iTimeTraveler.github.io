<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <!-- PACE Progress Bar START -->
  
    <script src="../../../../js/pace.min.js"></script>
    <link rel="stylesheet" href="https://github.com/HubSpot/pace/raw/master/themes/orange/pace-theme-flash.css">
  
  

  <!-- PACE Progress Bar START -->

  
  <title>ã€androidã€‘eventbus 3.0 æºç åˆ†æ | iTimeTraveler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="Androidæºç åˆ†æ" />
  
  
  
  
  <meta name="description" content="æ¦‚è¿°EventBusæ˜¯Androidä¸­ä¸€ä¸ªåŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¡†æ¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡æå°‘çš„ä»£ç å»å®ç°å¤šä¸ªæ¨¡å—ä¹‹é—´çš„é€šä¿¡ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æ›¿ä»£Intentï¼ŒHandlerï¼ŒBroadCast åœ¨ Fragmentï¼ŒActivityï¼ŒServiceï¼Œçº¿ç¨‹Threadä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚ä¼˜ç‚¹æ˜¯å¼€é”€å°ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šé™ä½å®ƒä»¬ä¹‹é—´çš„è€¦åˆã€‚ ç±»ä¼¼çš„åº“è¿˜æœ‰Otto ï¼Œä»Šå¤©å°±å¸¦å¤§å®¶ä¸€èµ·ç ”è¯» EventBus">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€Androidã€‘EventBus 3.0 æºç åˆ†æ">
<meta property="og:url" content="http://github.com/2017/09/30/ã€Androidã€‘EventBus 3.0æºç åˆ†æ/index.html">
<meta property="og:site_name" content="iTimeTraveler">
<meta property="og:description" content="æ¦‚è¿°EventBusæ˜¯Androidä¸­ä¸€ä¸ªåŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¡†æ¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡æå°‘çš„ä»£ç å»å®ç°å¤šä¸ªæ¨¡å—ä¹‹é—´çš„é€šä¿¡ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æ›¿ä»£Intentï¼ŒHandlerï¼ŒBroadCast åœ¨ Fragmentï¼ŒActivityï¼ŒServiceï¼Œçº¿ç¨‹Threadä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚ä¼˜ç‚¹æ˜¯å¼€é”€å°ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šé™ä½å®ƒä»¬ä¹‹é—´çš„è€¦åˆã€‚ ç±»ä¼¼çš„åº“è¿˜æœ‰Otto ï¼Œä»Šå¤©å°±å¸¦å¤§å®¶ä¸€èµ·ç ”è¯» EventBus">
<meta property="og:image" content="http://github.com/gallery/EventBus/android_with_eventbus.png">
<meta property="og:updated_time" content="2017-10-10T03:13:52.115Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€Androidã€‘EventBus 3.0 æºç åˆ†æ">
<meta name="twitter:description" content="æ¦‚è¿°EventBusæ˜¯Androidä¸­ä¸€ä¸ªåŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¡†æ¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡æå°‘çš„ä»£ç å»å®ç°å¤šä¸ªæ¨¡å—ä¹‹é—´çš„é€šä¿¡ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æ›¿ä»£Intentï¼ŒHandlerï¼ŒBroadCast åœ¨ Fragmentï¼ŒActivityï¼ŒServiceï¼Œçº¿ç¨‹Threadä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚ä¼˜ç‚¹æ˜¯å¼€é”€å°ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šé™ä½å®ƒä»¬ä¹‹é—´çš„è€¦åˆã€‚ ç±»ä¼¼çš„åº“è¿˜æœ‰Otto ï¼Œä»Šå¤©å°±å¸¦å¤§å®¶ä¸€èµ·ç ”è¯» EventBus">
<meta name="twitter:image" content="http://github.com/gallery/EventBus/android_with_eventbus.png">
  
    <link rel="alternate" href="/atom.xml" title="iTimeTraveler" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../../../css/my.css">

</head>

<script>
var themeMenus = {};

  themeMenus[""] = "é¦–é¡µ"; 

  themeMenus["../archives"] = "å½’æ¡£"; 

  themeMenus["../categories"] = "åˆ†ç±»"; 

  themeMenus["../tags"] = "æ ‡ç­¾"; 

  themeMenus["../funnysite"] = "é…·ç«™"; 

  themeMenus["../collection"] = "æ”¶è—"; 

  themeMenus["../about"] = "å…³äº"; 

  themeMenus["mybooks"] = "ğŸ"; 

</script>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="iTimeTraveler" rel="home"> iTimeTraveler </a>
            
          </h1>

          
            <div class="site-description">Someone knock at the door.</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../index.html">é¦–é¡µ</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../archives">å½’æ¡£</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../categories">åˆ†ç±»</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../tags">æ ‡ç­¾</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../funnysite">é…·ç«™</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../collection">æ”¶è—</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../about">å…³äº</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="../../../../mybooks">ğŸ</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div id="originBgDiv" style="background: #fff; width: 100%;">

      <div style="max-height:600px; overflow: hidden;  display: flex; display: -webkit-flex; align-items: center;">
        <img id="originBg" width="100%" alt="" src="">
      </div>

  </div>

  <script>
  function setAboutIMG(){
      var imgUrls = "https://source.unsplash.com/collection/954550/1920x1080,gallery/bg/01.jpg,gallery/bg/02.jpg,gallery/bg/03.jpg,gallery/bg/04.jpg,gallery/bg/05.jpg,gallery/bg/06.jpg,gallery/bg/07.jpg,gallery/bg/08.jpg,gallery/bg/09.jpg,gallery/bg/10.jpg,gallery/bg/11.jpg,gallery/bg/12.jpg".split(",");
      var random = Math.floor((Math.random() * imgUrls.length ));
      if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
        document.getElementById("originBg").src=imgUrls[random];
      } else {
        document.getElementById("originBg").src='/' + imgUrls[random];
      }
  }
  bgDiv=document.getElementById("originBgDiv");
  if(location.pathname.match('about')){
    setAboutIMG();
    bgDiv.style.display='block';
  }else{
    bgDiv.style.display='none';
  }
  </script>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-ã€Androidã€‘EventBus 3.0æºç åˆ†æ" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="../../../../gallery/EventBus/android_with_eventbus.png" rel="gallery_cjaltewnu002zyomyz3v1dxpt">
        <img src="../../../../gallery/EventBus/android_with_eventbus.png" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ã€Androidã€‘EventBus 3.0 æºç åˆ†æ
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="" class="article-date">
	  <time datetime="2017-09-30T14:03:00.000Z" itemprop="datePublished">ä¹æœˆ 30, 2017</time>
	</a>

      
	<span id="busuanzi_container_page_pv">
	  æœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p><strong><a href="https://github.com/greenrobot/EventBus">EventBus</a></strong>æ˜¯Androidä¸­ä¸€ä¸ªåŸºäº<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¡†æ¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡æå°‘çš„ä»£ç å»å®ç°å¤šä¸ªæ¨¡å—ä¹‹é—´çš„é€šä¿¡ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æ›¿ä»£Intentï¼ŒHandlerï¼ŒBroadCast åœ¨ Fragmentï¼ŒActivityï¼ŒServiceï¼Œçº¿ç¨‹Threadä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚ä¼˜ç‚¹æ˜¯å¼€é”€å°ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šé™ä½å®ƒä»¬ä¹‹é—´çš„è€¦åˆã€‚ ç±»ä¼¼çš„åº“è¿˜æœ‰<a href="https://github.com/square/otto">Otto</a> ï¼Œä»Šå¤©å°±å¸¦å¤§å®¶ä¸€èµ·ç ”è¯» EventBus çš„æºç ã€‚</p>
<p>è¿™æ˜¯EventBusæºç ä¸­çš„ä»‹ç»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * EventBus is a central publish/subscribe event system for Android. Events are posted (&#123;<span class="doctag">@link</span> #post(Object)&#125;) to the</div><div class="line"> * bus, which delivers it to subscribers that have a matching handler method for the event type. To receive events,</div><div class="line"> * subscribers must register themselves to the bus using &#123;<span class="doctag">@link</span> #register(Object)&#125;. Once registered, subscribers</div><div class="line"> * receive events until &#123;<span class="doctag">@link</span> #unregister(Object)&#125; is called. Event handling methods must be annotated by</div><div class="line"> * &#123;<span class="doctag">@link</span> Subscribe&#125;, must be public, return nothing (void), and have exactly one parameter</div><div class="line"> * (the event).</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> Markus Junginger, greenrobot</div><div class="line"> */</div></pre></td></tr></table></figure>
<blockquote>
<p>EventBus æ˜¯Androidä¸Šçš„ä»¥<strong>å‘å¸ƒ\è®¢é˜…äº‹ä»¶</strong>ä¸ºæ ¸å¿ƒçš„åº“ã€‚äº‹ä»¶ (<code>event</code>) é€šè¿‡ <code>post()</code> å‘é€åˆ°æ€»çº¿ï¼Œç„¶åå†åˆ†å‘åˆ°åŒ¹é…äº‹ä»¶ç±»å‹çš„è®¢é˜…è€… (<code>subscribers</code>) ã€‚è®¢é˜…è€…åªæœ‰åœ¨æ€»çº¿ä¸­æ³¨å†Œ (<code>register</code>) äº†æ‰èƒ½æ”¶åˆ°äº‹ä»¶ï¼Œæ³¨é”€ (<code>unrigister</code>) ä¹‹åå°±æ”¶ä¸åˆ°ä»»ä½•äº‹ä»¶äº†ã€‚äº‹ä»¶æ–¹æ³•å¿…é¡»å¸¦æœ‰ <code>Subscribe</code> çš„æ³¨è§£ï¼Œå¿…é¡»æ˜¯ <code>public</code> ï¼Œæ²¡æœ‰è¿”å›ç±»å‹ <code>void</code> å¹¶ä¸”åªèƒ½æœ‰ä¸€ä¸ªå‚æ•°ã€‚</p>
</blockquote>
<p>EventBus3 ä¸ä¹‹å‰çš„ç›¸æ¯”ï¼Œå…¶ä¸»è¦å·®åˆ«åœ¨äºè®¢é˜…æ–¹æ³•å¯ä»¥ä¸å†ä»¥<code>onEvent</code> å¼€å¤´äº†ï¼Œæ”¹ä¸ºç”¨<strong>æ³¨è§£</strong>ã€‚</p>
<a id="more"></a>
<h3 id="ä¸€ã€ä½¿ç”¨EventBus"><a href="#ä¸€ã€ä½¿ç”¨EventBus" class="headerlink" title="ä¸€ã€ä½¿ç”¨EventBus"></a>ä¸€ã€ä½¿ç”¨EventBus</h3><p><img src="/gallery/EventBus/how_to_use.png" alt=""></p>
<p>åœ¨Gradleä¸­æ·»åŠ ä¾èµ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">compile <span class="string">'org.greenrobot:eventbus:3.0.0'</span></div></pre></td></tr></table></figure>
<h4 id="1-1-åˆå§‹åŒ–"><a href="#1-1-åˆå§‹åŒ–" class="headerlink" title="1.1 åˆå§‹åŒ–"></a>1.1 åˆå§‹åŒ–</h4><p>EventBusé»˜è®¤æœ‰ä¸€ä¸ªå•ä¾‹ï¼Œå¯ä»¥é€šè¿‡<code>getDefault()</code>è·å–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>EventBus.builder()</code>æ„é€ è‡ªå®šä¹‰çš„EventBusï¼Œæ¯”å¦‚è¦åº”ç”¨æˆ‘ä»¬ç”Ÿæˆå¥½çš„ç´¢å¼•æ—¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EventBus mEventBus = EventBus.builder().addIndex(<span class="keyword">new</span> MyEventBusIndex()).build();</div></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³æŠŠè‡ªå®šä¹‰çš„è®¾ç½®åº”ç”¨åˆ°EventBusé»˜è®¤çš„å•ä¾‹ä¸­ï¼Œåˆ™å¯ä»¥ç”¨<code>installDefaultEventBus()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EventBus.builder().addIndex(<span class="keyword">new</span> MyEventBusIndex()).installDefaultEventBus();</div></pre></td></tr></table></figure>
<h4 id="1-2-å®šä¹‰äº‹ä»¶"><a href="#1-2-å®šä¹‰äº‹ä»¶" class="headerlink" title="1.2 å®šä¹‰äº‹ä»¶"></a>1.2 å®šä¹‰äº‹ä»¶</h4><p>æ‰€æœ‰èƒ½è¢«å®ä¾‹åŒ–ä¸ºObjectçš„å®ä¾‹éƒ½å¯ä»¥ä½œä¸ºäº‹ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageEvent</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String message;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageEvent</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.message = message;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æœ€æ–°ç‰ˆçš„eventbus 3ä¸­å¦‚æœç”¨åˆ°äº†ç´¢å¼•åŠ é€Ÿï¼Œäº‹ä»¶ç±»çš„ä¿®é¥°ç¬¦å¿…é¡»ä¸º<strong>public</strong>ï¼Œä¸ç„¶ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ï¼š<code>Subscriber method must be public</code>ã€‚</p>
<h4 id="1-3-ç›‘å¬äº‹ä»¶"><a href="#1-3-ç›‘å¬äº‹ä»¶" class="headerlink" title="1.3 ç›‘å¬äº‹ä»¶"></a>1.3 ç›‘å¬äº‹ä»¶</h4><p>è®¢é˜…è€…éœ€è¦åœ¨æ€»çº¿ä¸Šæ³¨å†Œå’Œæ³¨é”€è‡ªå·±ã€‚åªæœ‰å½“è®¢é˜…è€…æ³¨å†Œäº†æ‰èƒ½æ¥æ”¶åˆ°äº‹ä»¶ã€‚åœ¨Androidä¸­ï¼Œé€šå¸¸ä¸ Activity å’Œ Fragment çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·ã€‚</p>
<p>ä¹‹å‰2.xç‰ˆæœ¬ä¸­æœ‰å››ç§æ³¨å†Œæ–¹æ³•ï¼ŒåŒºåˆ†äº†æ™®é€šæ³¨å†Œå’Œç²˜æ€§äº‹ä»¶æ³¨å†Œï¼Œå¹¶ä¸”åœ¨æ³¨å†Œæ—¶å¯ä»¥é€‰æ‹©æ¥æ”¶äº‹ä»¶çš„ä¼˜å…ˆçº§ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å¯¹2.xç‰ˆæœ¬åšè¿‡å¤šçš„ç ”ç©¶äº†ã€‚ç”±äº3.0ç‰ˆæœ¬å°†ç²˜æ€§äº‹ä»¶ä»¥åŠè®¢é˜…äº‹ä»¶çš„ä¼˜å…ˆçº§æ¢æˆäº†<strong>æ³¨è§£</strong>çš„å®ç°æ–¹å¼ï¼Œæ‰€ä»¥3.0ç‰ˆæœ¬ä¸­çš„æ³¨å†Œå°±å˜å¾—ç®€å•ï¼Œåªæœ‰ä¸€ä¸ªregister()æ–¹æ³•å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">//3.0ç‰ˆæœ¬çš„æ³¨å†Œ</span></div><div class="line">EventBus.getDefault().register(<span class="keyword">this</span>);</div><div class="line">	   </div><div class="line"><span class="comment">//2.xç‰ˆæœ¬çš„å››ç§æ³¨å†Œæ–¹æ³•</span></div><div class="line">EventBus.getDefault().register(<span class="keyword">this</span>);</div><div class="line">EventBus.getDefault().register(<span class="keyword">this</span>, <span class="number">100</span>);</div><div class="line">EventBus.getDefault().registerSticky(<span class="keyword">this</span>);</div><div class="line">EventBus.getDefault().registerSticky(<span class="keyword">this</span>, <span class="number">100</span>);</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ä¸åœ¨éœ€è¦æ¥æ”¶äº‹ä»¶çš„æ—¶å€™éœ€è¦è§£é™¤æ³¨å†Œunregisterï¼Œ2.xå’Œ3.0çš„è§£é™¤æ³¨å†Œä¹Ÿæ˜¯ç›¸åŒçš„ã€‚ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">//å–æ¶ˆæ³¨å†Œ</span></div><div class="line">EventBus.getDefault().unregister(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
<p>æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åçš„å¤„ç†æ–¹å¼ï¼Œåœ¨2.xç‰ˆæœ¬ä¸­ï¼Œæ³¨å†Œè¿™äº›æ¶ˆæ¯çš„ç›‘å¬éœ€è¦åŒºåˆ†æ˜¯å¦ç›‘å¬é»æ€§ï¼ˆstickyï¼‰äº‹ä»¶ï¼Œç›‘å¬EventBusäº‹ä»¶çš„æ¨¡å—éœ€è¦å®ç°ä»¥onEventå¼€å¤´çš„æ–¹æ³•ã€‚å¦‚ä»Š3.0æ”¹ä¸ºåœ¨æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£çš„å½¢å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">//3.0ç‰ˆæœ¬</span></div><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.POSTING, priority = <span class="number">0</span>, sticky = <span class="keyword">true</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleEvent</span><span class="params">(DriverEvent event)</span> </span>&#123;</div><div class="line">    Log.d(TAG, event.info);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//2.xç‰ˆæœ¬</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventBackgroundThread</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨2.xç‰ˆæœ¬ä¸­åªæœ‰é€šè¿‡onEventå¼€å¤´çš„æ–¹æ³•ä¼šè¢«æ³¨å†Œï¼Œè€Œä¸”å“åº”äº‹ä»¶æ–¹æ³•è§¦å‘çš„çº¿ç¨‹é€šè¿‡<code>onEventMainThread</code>æˆ–<code>onEventBackgroundThread</code>è¿™äº›æ–¹æ³•ååŒºåˆ†ï¼Œè€Œåœ¨3.0ç‰ˆæœ¬ä¸­ï¼Œé€šè¿‡<code>@Subscribe</code>æ³¨è§£ï¼Œæ¥ç¡®å®šè¿è¡Œçš„çº¿ç¨‹threadModeï¼Œæ˜¯å¦æ¥å—ç²˜æ€§äº‹ä»¶stickyä»¥åŠäº‹ä»¶ä¼˜å…ˆçº§priorityï¼Œè€Œä¸”æ–¹æ³•åä¸åœ¨éœ€è¦<code>onEvent</code>å¼€å¤´ï¼Œæ‰€ä»¥åˆç®€æ´çµæ´»äº†ä¸å°‘ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ³¨è§£<code>@Subscribe</code>æœ‰ä¸‰ä¸ªå‚æ•°ï¼ŒthreadModeä¸ºå›è°ƒæ‰€åœ¨çš„çº¿ç¨‹ï¼Œpriorityä¸ºä¼˜å…ˆçº§ï¼Œstickyä¸ºæ˜¯å¦æ¥æ”¶é»æ€§äº‹ä»¶ã€‚è°ƒåº¦å•ä½ä»ç±»ç»†åŒ–åˆ°äº†æ–¹æ³•ï¼Œå¯¹æ–¹æ³•çš„å‘½åä¹Ÿæ²¡æœ‰äº†è¦æ±‚ï¼Œæ–¹ä¾¿æ··æ·†ä»£ç ã€‚ä½†æ³¨å†Œäº†ç›‘å¬çš„æ¨¡å—å¿…é¡»æœ‰ä¸€ä¸ªæ ‡æ³¨äº†Subscribeæ³¨è§£æ–¹æ³•ï¼Œä¸ç„¶åœ¨registeræ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Subscriber class XXX and its super classes have no public methods with the @Subscribe annotation</div></pre></td></tr></table></figure>
<h4 id="1-4-å‘é€äº‹ä»¶"><a href="#1-4-å‘é€äº‹ä»¶" class="headerlink" title="1.4 å‘é€äº‹ä»¶"></a>1.4 å‘é€äº‹ä»¶</h4><p>å¯ä»¥ä»ä»£ç çš„ä»»ä½•åœ°æ–¹è°ƒç”¨postæˆ–è€…postStickyå‘é€äº‹ä»¶ï¼Œæ­¤æ—¶æ³¨å†Œäº†çš„ä¸”åŒ¹é…äº‹ä»¶çš„è®¢é˜…è€…èƒ½å¤Ÿæ¥æ”¶åˆ°äº‹ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">EventBus.getDefault().post(<span class="keyword">new</span> MessageEvent(<span class="string">"Hello everyone!"</span>));</div></pre></td></tr></table></figure>
<p>åœ¨å®é™…é¡¹ç›®çš„ä½¿ç”¨ä¸­ï¼Œregisterå’Œunregisteré€šå¸¸ä¸Activityå’ŒFragmentçš„ç”Ÿå‘½å‘¨æœŸç›¸å…³ï¼ŒThreadMode.MainThreadå¯ä»¥å¾ˆå¥½åœ°è§£å†³Androidçš„ç•Œé¢åˆ·æ–°å¿…é¡»åœ¨UIçº¿ç¨‹çš„é—®é¢˜ï¼Œä¸éœ€è¦å†å›è°ƒåç”¨Handlerä¸­è½¬ï¼ˆ<strong>EventBusä¸­å·²ç»è‡ªåŠ¨ç”¨Handleråšäº†å¤„ç†</strong>ï¼‰ï¼Œé»æ€§äº‹ä»¶å¯ä»¥å¾ˆå¥½åœ°è§£å†³postä¸registeråŒæ—¶æ‰§è¡Œæ—¶çš„å¼‚æ­¥é—®é¢˜ï¼ˆè¿™ä¸ªåœ¨åŸç†ä¸­ä¼šè¯´åˆ°ï¼‰ï¼Œäº‹ä»¶çš„ä¼ é€’ä¹Ÿæ²¡æœ‰åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ€§èƒ½æ¶ˆè€—ï¼Œè¶³ä»¥æ»¡è¶³æˆ‘ä»¬å¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„æ¨¡å—é—´é€šä¿¡éœ€æ±‚ã€‚</p>
<h3 id="äºŒã€EventBusæºç è·Ÿè¸ª"><a href="#äºŒã€EventBusæºç è·Ÿè¸ª" class="headerlink" title="äºŒã€EventBusæºç è·Ÿè¸ª"></a>äºŒã€EventBusæºç è·Ÿè¸ª</h3><p>æˆ‘ä»¬é€šè¿‡<code>EventBus</code>çš„ä½¿ç”¨æµç¨‹æ¥è·Ÿè¸ªåˆ†æå®ƒçš„è°ƒç”¨æµç¨‹ï¼Œé€šè¿‡æˆ‘ä»¬ç†Ÿæ‚‰çš„ä½¿ç”¨æ–¹æ³•æ¥æ·±å…¥åˆ°<code>EventBus</code>çš„å®ç°å†…éƒ¨å¹¶ç†è§£å®ƒçš„å®ç°åŸç†ã€‚</p>
<h4 id="2-1-åˆ›å»ºEventBuså¯¹è±¡"><a href="#2-1-åˆ›å»ºEventBuså¯¹è±¡" class="headerlink" title="2.1 åˆ›å»ºEventBuså¯¹è±¡"></a><strong>2.1 åˆ›å»ºEventBuså¯¹è±¡</strong></h4><p>å…ˆçœ‹çœ‹ <code>getDefault()</code> :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> EventBus defaultInstance;</div><div class="line"></div><div class="line"><span class="comment">/** Convenience singleton for apps using a process-wide EventBus instance. */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">            <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                defaultInstance = <span class="keyword">new</span> EventBus();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> defaultInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±æ˜¯è®¾è®¡æ¨¡å¼é‡Œæˆ‘ä»¬å¸¸ç”¨çš„<strong>å•ä¾‹æ¨¡å¼</strong>ï¼Œç”¨åˆ°äº†double checkã€‚ä¿è¯äº†<code>getDefault()</code>å¾—åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚å¦‚æœä¸å­˜åœ¨å®ä¾‹ï¼Œå°±è°ƒç”¨äº†<code>EventBus</code>çš„æ„é€ æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ„é€ å‡½æ•°å¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒçš„EventBusï¼Œä¸åŒçš„å®ä¾‹ä¹‹é—´å¯ä»¥ç›¸äº’éš”ç¦»ï¼Œå¦‚æœåªæƒ³ä½¿ç”¨åŒä¸€ä¸ªæ€»çº¿ï¼Œå°±ç›´æ¥ä½¿ç”¨getDefault()æ–¹æ³•è·å–å•ä¾‹</div><div class="line"> * </div><div class="line"> * Creates a new EventBus instance; each instance is a separate scope in which events are delivered. To use a</div><div class="line"> * central bus, consider &#123;<span class="doctag">@link</span> #getDefault()&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>(DEFAULT_BUILDER);</div><div class="line">&#125;</div><div class="line"></div><div class="line">EventBus(EventBusBuilder builder) &#123;</div><div class="line">	<span class="comment">//key:è®¢é˜…çš„äº‹ä»¶,value:è®¢é˜…è¿™ä¸ªäº‹ä»¶çš„æ‰€æœ‰è®¢é˜…è€…é›†åˆ</span></div><div class="line">	<span class="comment">//private final Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;</span></div><div class="line">	subscriptionsByEventType = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">	</div><div class="line">	<span class="comment">//key:è®¢é˜…è€…å¯¹è±¡,value:è¿™ä¸ªè®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶é›†åˆ</span></div><div class="line">	<span class="comment">//private final Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;</span></div><div class="line">	typesBySubscriber = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">	</div><div class="line">	<span class="comment">//ç²˜æ€§äº‹ä»¶ key:ç²˜æ€§äº‹ä»¶çš„classå¯¹è±¡, value:äº‹ä»¶å¯¹è±¡</span></div><div class="line">	<span class="comment">//private final Map&lt;Class&lt;?&gt;, Object&gt; stickyEvents;</span></div><div class="line">	stickyEvents = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">	</div><div class="line">	<span class="comment">//äº‹ä»¶ä¸»çº¿ç¨‹å¤„ç†</span></div><div class="line">	mainThreadPoster = <span class="keyword">new</span> HandlerPoster(<span class="keyword">this</span>, Looper.getMainLooper(), <span class="number">10</span>);</div><div class="line">	<span class="comment">//äº‹ä»¶ Background å¤„ç†</span></div><div class="line">	backgroundPoster = <span class="keyword">new</span> BackgroundPoster(<span class="keyword">this</span>);</div><div class="line">	<span class="comment">//äº‹ä»¶å¼‚æ­¥çº¿ç¨‹å¤„ç†</span></div><div class="line">	asyncPoster = <span class="keyword">new</span> AsyncPoster(<span class="keyword">this</span>);</div><div class="line">	indexCount = builder.subscriberInfoIndexes != <span class="keyword">null</span> ? builder.subscriberInfoIndexes.size() : <span class="number">0</span>;</div><div class="line">	<span class="comment">//è®¢é˜…è€…å“åº”å‡½æ•°ä¿¡æ¯å­˜å‚¨å’ŒæŸ¥æ‰¾ç±»</span></div><div class="line">	subscriberMethodFinder = <span class="keyword">new</span> SubscriberMethodFinder(builder.subscriberInfoIndexes,</div><div class="line">	       builder.strictMethodVerification, builder.ignoreGeneratedIndex);</div><div class="line">	logSubscriberExceptions = builder.logSubscriberExceptions;</div><div class="line">	logNoSubscriberMessages = builder.logNoSubscriberMessages;</div><div class="line">	sendSubscriberExceptionEvent = builder.sendSubscriberExceptionEvent;</div><div class="line">	sendNoSubscriberEvent = builder.sendNoSubscriberEvent;</div><div class="line">	throwSubscriberException = builder.throwSubscriberException;</div><div class="line">	<span class="comment">//æ˜¯å¦æ”¯æŒäº‹ä»¶ç»§æ‰¿</span></div><div class="line">	eventInheritance = builder.eventInheritance;</div><div class="line">	executorService = builder.executorService;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»€ä¹ˆï¼Œæ—¢ç„¶æ˜¯å•ä¾‹æ¨¡å¼æ„é€ å‡½æ•°è¿˜æ˜¯ <code>public</code> ï¼Ÿæ²¡é”™ï¼Œè¿™æ ·çš„è®¾è®¡æ˜¯å› ä¸ºä¸ä»…ä»…å¯ä»¥åªæœ‰ä¸€æ¡æ€»çº¿ï¼Œè¿˜å¯ä»¥æœ‰å…¶ä»–çš„çº¿ (bus) ï¼Œè®¢é˜…è€…å¯ä»¥æ³¨å†Œåˆ°ä¸åŒçš„çº¿ä¸Šçš„ <code>EventBus</code>ï¼Œé€šè¿‡ä¸åŒçš„ <code>EventBus</code> å®ä¾‹æ¥å‘é€æ•°æ®ï¼Œä¸åŒçš„ <code>EventBus</code> æ˜¯ç›¸äº’éš”ç¦»å¼€çš„ï¼Œè®¢é˜…è€…éƒ½åªä¼šæ”¶åˆ°æ³¨å†Œåˆ°è¯¥çº¿ä¸Šäº‹ä»¶ã€‚</p>
<p>ç„¶åæˆ‘ä»¬è¯´ä¸€ä¸‹æ„é€ å‡½æ•°é‡Œè¿™ä¸‰ä¸ª <code>HasMap</code>ã€‚</p>
<ul>
<li><strong><code>subscriptionsByEventType</code></strong> æ˜¯ä»¥ <code>event</code> ä¸º <em>key</em>ï¼Œ<code>subscriberåˆ—è¡¨</code> ä¸º <em>value</em>ï¼Œå½“å‘é€ <code>event</code> çš„æ—¶å€™ï¼Œéƒ½æ˜¯å»è¿™é‡Œæ‰¾å¯¹åº”çš„è®¢é˜…è€…ã€‚</li>
<li><strong><code>typesBySubscriber</code></strong> æ˜¯ä»¥ <code>subscriber</code> ä¸º <em>key</em>ï¼Œ<code>eventåˆ—è¡¨</code>ä¸º <em>value</em>ï¼Œå½“ <code>register()</code> å’Œ <code>unregister()</code> çš„æ—¶å€™éƒ½æ˜¯æ“ä½œè¿™ä¸ªmapï¼ŒåŒæ—¶å¯¹ <code>subscriptionsByEventType</code> è¿›è¡Œå¯¹ç”¨æ“ä½œã€‚</li>
<li><strong><code>stickyEvents</code></strong> ç»´æŠ¤çš„æ˜¯ç²˜æ€§äº‹ä»¶ï¼Œç²˜æ€§äº‹ä»¶ä¹Ÿå°±æ˜¯å½“ <code>event</code> å‘é€å‡ºå»ä¹‹åå†æ³¨å†Œç²˜æ€§äº‹ä»¶çš„è¯ï¼Œè¯¥ç²˜æ€§äº‹ä»¶ä¹Ÿèƒ½æ”¶åˆ°ä¹‹å‰å‘é€å‡ºå»çš„ <code>event</code>ã€‚</li>
</ul>
<p>åŒæ—¶æ„é€ å‡½æ•°ä¸­è¿˜åˆ›å»ºäº† 3 ä¸ª poster ï¼š<strong>HandlerPoster ï¼ŒBackgroundPosterå’ŒAsyncPosterï¼Œè¿™ 3 ä¸ª poster è´Ÿè´£çº¿ç¨‹é—´è°ƒåº¦</strong>ï¼Œç¨åçš„äº‹ä»¶åˆ†å‘æ¨¡å—æˆ‘ä»¬ä¼šè¯¦ç»†è®²åˆ°ã€‚æˆ‘ä»¬æ¥ç€çœ‹è¿™ä¸ªæ„é€ å‡½æ•°ä¸­ï¼Œæœ€ç»ˆè¿ç”¨åˆ°äº†builderè®¾è®¡æ¨¡å¼ï¼Œé‚£ä¹ˆæ¥çœ‹çœ‹è¿™ä¸ª <code>EventBusBuilder</code> ä¸­æœ‰å“ªäº›å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusBuilder</span> </span>&#123;</div><div class="line">	<span class="comment">//çº¿ç¨‹æ± </span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ExecutorService DEFAULT_EXECUTOR_SERVICE = Executors.newCachedThreadPool();</div><div class="line">	<span class="comment">//å½“è°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°å¼‚å¸¸æ—¶æ˜¯å¦æ‰“å°å¼‚å¸¸ä¿¡æ¯</span></div><div class="line">	<span class="keyword">boolean</span> logSubscriberExceptions = <span class="keyword">true</span>;</div><div class="line">	<span class="comment">//å½“æ²¡æœ‰è®¢é˜…è€…è®¢é˜…è¯¥äº‹ä»¶æ—¶æ˜¯å¦æ‰“å°æ—¥å¿—</span></div><div class="line">	<span class="keyword">boolean</span> logNoSubscriberMessages = <span class="keyword">true</span>;</div><div class="line">	<span class="comment">//å½“è°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°å¼‚å¸¸æ—¶æ˜¯å¦å‘é€ SubscriberExceptionEvent äº‹ä»¶</span></div><div class="line">	<span class="keyword">boolean</span> sendSubscriberExceptionEvent = <span class="keyword">true</span>;</div><div class="line">	<span class="comment">//å½“æ²¡æœ‰äº‹ä»¶å¤„ç†å‡½æ•°å¯¹äº‹ä»¶å¤„ç†æ—¶æ˜¯å¦å‘é€ NoSubscriberEvent äº‹ä»¶</span></div><div class="line">	<span class="keyword">boolean</span> sendNoSubscriberEvent = <span class="keyword">true</span>;</div><div class="line">	<span class="comment">//æ˜¯å¦è¦æŠ›å‡ºå¼‚å¸¸ï¼Œå»ºè®®debugå¼€å¯</span></div><div class="line">	<span class="keyword">boolean</span> throwSubscriberException;</div><div class="line">	<span class="comment">//ä¸eventæœ‰ç»§æ‰¿å…³ç³»çš„ç±»æ˜¯å¦éœ€è¦å‘é€</span></div><div class="line">	<span class="keyword">boolean</span> eventInheritance = <span class="keyword">true</span>;</div><div class="line">	<span class="comment">//æ˜¯å¦å¿½ç•¥ç”Ÿæˆçš„ç´¢å¼•(SubscriberInfoIndex)</span></div><div class="line">	<span class="keyword">boolean</span> ignoreGeneratedIndex;</div><div class="line">	<span class="comment">//æ˜¯å¦ä¸¥æ ¼çš„æ–¹æ³•åæ ¡éªŒ</span></div><div class="line">	<span class="keyword">boolean</span> strictMethodVerification;</div><div class="line">	<span class="comment">//çº¿ç¨‹æ± ï¼Œasync å’Œ background çš„äº‹ä»¶ä¼šç”¨åˆ°</span></div><div class="line">	ExecutorService executorService = DEFAULT_EXECUTOR_SERVICE;</div><div class="line">	<span class="comment">//å½“æ³¨å†Œçš„æ—¶å€™ä¼šè¿›è¡Œæ–¹æ³•åçš„æ ¡éªŒ(EventBus3ä¹‹å‰æ–¹æ³•åå¿…é¡»ä»¥onEventå¼€å¤´)ï¼Œè€Œè¿™ä¸ªåˆ—è¡¨æ˜¯ä¸å‚åŠ æ ¡éªŒçš„ç±»çš„åˆ—è¡¨(EventBus3ä¹‹åå°±æ²¡ç”¨è¿™ä¸ªå‚æ•°äº†)</span></div><div class="line">	List&lt;Class&lt;?&gt;&gt; skipMethodVerificationForClasses;</div><div class="line">	<span class="comment">//ç»´æŠ¤ç€ç”±EventBusç”Ÿæˆçš„ç´¢å¼•(SubscriberInfoIndex)</span></div><div class="line">	List&lt;SubscriberInfoIndex&gt; subscriberInfoIndexes;</div><div class="line"></div><div class="line">	EventBusBuilder() &#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//èµ‹å€¼buidler(å¯ç”¨æˆ·è‡ªå®šä¹‰çš„)ç»™å•ä¾‹çš„EventBusï¼Œå¦‚æœå•ä¾‹çš„EventBusä¸ä¸ºnulläº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">	<span class="function"><span class="keyword">public</span> EventBus <span class="title">installDefaultEventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">	        <span class="keyword">if</span> (EventBus.defaultInstance != <span class="keyword">null</span>) &#123;</div><div class="line">	            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Default instance already exists."</span> +</div><div class="line">	                    <span class="string">" It may be only set once before it's used the first time to ensure consistent behavior."</span>);</div><div class="line">	        &#125;</div><div class="line">	        EventBus.defaultInstance = build();</div><div class="line">	        <span class="keyword">return</span> EventBus.defaultInstance;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> EventBus <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="keyword">return</span> <span class="keyword">new</span> EventBus(<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//...çœç•¥å…¶ä»–ä»£ç ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºæ˜¯é€šè¿‡åˆå§‹åŒ–äº†ä¸€ä¸ª<code>EventBusBuilder()</code>å¯¹è±¡æ¥åˆ†åˆ«åˆå§‹åŒ–<code>EventBus</code>çš„ä¸€äº›é…ç½®ï¼Œæ³¨é‡Šé‡Œæˆ‘æ ‡æ³¨äº†å¤§éƒ¨åˆ†æ¯”è¾ƒé‡è¦çš„å¯¹è±¡ï¼Œè¿™é‡Œæ²¡å¿…è¦è®°ä½ï¼Œçœ‹ä¸‹é¢çš„æ–‡ç« æ—¶å¦‚æœå¯¹æŸä¸ªå¯¹è±¡ä¸äº†è§£ï¼Œå¯ä»¥å†å›æ¥çœ‹çœ‹ã€‚</p>
<h4 id="2-2-æ³¨å†Œä¸è®¢é˜…Register"><a href="#2-2-æ³¨å†Œä¸è®¢é˜…Register" class="headerlink" title="2.2 æ³¨å†Œä¸è®¢é˜…Register"></a><strong>2.2 æ³¨å†Œä¸è®¢é˜…Register</strong></h4><p>EventBus 3.0çš„æ³¨å†Œå…¥å£åªæä¾›ä¸€ä¸ª<code>register()</code>æ–¹æ³•äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹register()æ–¹æ³•åšäº†ä»€ä¹ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">    <span class="comment">//é¦–å…ˆè·å¾—è®¢é˜…è€…çš„classå¯¹è±¡</span></div><div class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();</div><div class="line">    </div><div class="line">    <span class="comment">//é€šè¿‡subscriberMethodFinderæ¥æ‰¾åˆ°è®¢é˜…è€…è®¢é˜…äº†å“ªäº›äº‹ä»¶.è¿”å›ä¸€ä¸ªSubscriberMethodå¯¹è±¡çš„List</span></div><div class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</div><div class="line">            <span class="comment">//è®¢é˜…</span></div><div class="line">            subscribe(subscriber, subscriberMethod);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>register()</code>æ–¹æ³•å¾ˆç®€æ´ï¼Œä»£ç é‡Œçš„æ³¨é‡Šä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºé€šè¿‡<code>subscriberMethodFinder.findSubscriberMethods(subscriberClass)</code>æ–¹æ³•å°±èƒ½è¿”å›ä¸€ä¸ª<code>SubscriberMethod</code>çš„å¯¹è±¡ï¼Œè€Œ<code>SubscriberMethod</code>é‡ŒåŒ…å«äº†æ‰€æœ‰æˆ‘ä»¬éœ€è¦çš„æ¥ä¸‹æ¥æ‰§è¡Œ<code>subscribe()</code>çš„ä¿¡æ¯ã€‚</p>
<p>é‚£ <strong><code>SubscriberMethod</code></strong>é‡ŒåŒ…å«äº†ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æ˜¯å®ƒçš„å˜é‡å’Œæ„é€ å‡½æ•°ã€‚å¯ä»¥çœ‹åˆ°é‡Œé¢åŒ…æ‹¬è®¢é˜…ç±»é‡Œçš„å…·ä½“æ‰§è¡Œæ–¹æ³•<code>Method</code>å¯¹è±¡ï¼Œéœ€è¦åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œ<code>ThreadMode</code>ï¼Œäº‹ä»¶ç±»å‹<code>eventType</code>ï¼Œä¼˜å…ˆçº§<code>priority</code>ï¼Œä»¥åŠæ˜¯å¦æ¥æ”¶ç²˜æ€§<code>sticky</code>äº‹ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscriberMethod</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Method method;        <span class="comment">//å…·ä½“çš„æ‰§è¡Œæ–¹æ³•</span></div><div class="line">    <span class="keyword">final</span> ThreadMode threadMode; <span class="comment">//æ‰§è¡Œçº¿ç¨‹</span></div><div class="line">    <span class="keyword">final</span> Class&lt;?&gt; eventType;   <span class="comment">//äº‹ä»¶ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œæ–¹æ³•æ¥å—çš„å‚æ•°ç±»å‹</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> priority;         <span class="comment">//ä¼˜å…ˆçº§</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> sticky;       <span class="comment">//æ˜¯å¦ç²˜æ€§ï¼Œä¹‹åä¼šè®²åˆ°</span></div><div class="line">    <span class="comment">/** Used for efficient comparison */</span></div><div class="line">    String methodString;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubscriberMethod</span><span class="params">(Method method, Class&lt;?&gt; eventType, ThreadMode threadMode, <span class="keyword">int</span> priority, <span class="keyword">boolean</span> sticky)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.method = method;</div><div class="line">        <span class="keyword">this</span>.threadMode = threadMode;</div><div class="line">        <span class="keyword">this</span>.eventType = eventType;</div><div class="line">        <span class="keyword">this</span>.priority = priority;</div><div class="line">        <span class="keyword">this</span>.sticky = sticky;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...çœç•¥å…¶ä»–ä»£ç ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å»çœ‹çœ‹SubscriberMethodFinderç±»çš„<code>findSubscriberMethods()</code>æ˜¯æ€ä¹ˆæ‰¾åˆ°è®¢é˜…æ–¹æ³•çš„ï¼Œæœ€åæˆ‘ä»¬å†å»å…³æ³¨<code>subscribe()</code>ã€‚</p>
<p><strong>SubscriberMethodFinderçš„å®ç°</strong></p>
<p>ä»å­—é¢ç†è§£ï¼Œè¿™ä¸ªç±»å°±æ˜¯è®¢é˜…è€…æ–¹æ³•å‘ç°è€…ã€‚ä¸€å¥è¯æ¥æè¿°<code>SubscriberMethodFinder</code>ç±»å°±æ˜¯ç”¨æ¥<strong>æŸ¥æ‰¾å’Œç¼“å­˜è®¢é˜…è€…å“åº”å‡½æ•°çš„ä¿¡æ¯</strong>çš„ç±»ã€‚æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“æ€ä¹ˆèƒ½è·å¾—è®¢é˜…è€…å“åº”å‡½æ•°çš„ç›¸å…³ä¿¡æ¯ã€‚åœ¨3.0ç‰ˆæœ¬ä¸­ï¼ŒEventBusæä¾›äº†ä¸€ä¸ª<strong><code>EventBusAnnotationProcessor</code>æ³¨è§£å¤„ç†å™¨</strong>æ¥åœ¨ç¼–è¯‘æœŸé€šè¿‡è¯»å–<code>@Subscribe()</code>æ³¨è§£å¹¶è§£æï¼Œå¤„ç†å…¶ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯ï¼Œç„¶åç”Ÿæˆjavaç±»æ¥ä¿å­˜æ‰€æœ‰è®¢é˜…è€…å…³äºè®¢é˜…çš„ä¿¡æ¯ï¼Œè¿™æ ·å°±æ¯”åœ¨è¿è¡Œæ—¶ä½¿ç”¨åå°„æ¥è·å¾—è¿™äº›è®¢é˜…è€…çš„ä¿¡æ¯é€Ÿåº¦è¦å¿«ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒEventBusé¡¹ç›®é‡Œçš„<a href="https://github.com/greenrobot/EventBus/tree/master/EventBusPerformance">EventBusPerformance</a>è¿™ä¸ªä¾‹å­ï¼Œç¼–è¯‘åæˆ‘ä»¬å¯ä»¥åœ¨buildæ–‡ä»¶å¤¹é‡Œæ‰¾åˆ°è¿™ä¸ªç±»ï¼Œ<a href="https://github.com/greenrobot/EventBus/blob/master/EventBusPerformance/build.gradle#L27">MyEventBusIndex ç±»</a>ï¼Œå½“ç„¶ç±»åæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ã€‚æˆ‘ä»¬å¤§è‡´çœ‹ä¸€ä¸‹ç”Ÿæˆçš„<code>MyEventBusIndex</code>ç±»æ˜¯ä»€ä¹ˆæ ·çš„:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This class is generated by EventBus, do not edit.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventBusIndex</span> <span class="keyword">implements</span> <span class="title">SubscriberInfoIndex</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        SUBSCRIBER_INDEX = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, SubscriberInfo&gt;();</div><div class="line"></div><div class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(org.greenrobot.eventbusperf.testsubject.PerfTestEventBus.SubscriberClassEventBusAsync.class,</div><div class="line">                <span class="keyword">true</span>, <span class="keyword">new</span> SubscriberMethodInfo[]&#123;</div><div class="line">                <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventAsync"</span>, TestEvent.class, ThreadMode.ASYNC),</div><div class="line">        &#125;));</div><div class="line"></div><div class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(TestRunnerActivity.class, <span class="keyword">true</span>, <span class="keyword">new</span> SubscriberMethodInfo[]&#123;</div><div class="line">                <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventMainThread"</span>, TestFinishedEvent.class, ThreadMode.MAIN),</div><div class="line">        &#125;));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putIndex</span><span class="params">(SubscriberInfo info)</span> </span>&#123;</div><div class="line">        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">        SubscriberInfo info = SUBSCRIBER_INDEX.get(subscriberClass);</div><div class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> info;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºæ˜¯ä½¿ç”¨ä¸€ä¸ªé™æ€HashMapå³ï¼š<code>SUBSCRIBER_INDEX</code>æ¥ä¿å­˜è®¢é˜…ç±»çš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬äº†è®¢é˜…ç±»çš„classå¯¹è±¡ï¼Œæ˜¯å¦éœ€è¦æ£€æŸ¥çˆ¶ç±»ï¼Œä»¥åŠè®¢é˜…æ–¹æ³•çš„ä¿¡æ¯<code>SubscriberMethodInfo</code>çš„æ•°ç»„ï¼Œ<code>SubscriberMethodInfo</code>ä¸­åˆä¿å­˜äº†ï¼Œè®¢é˜…æ–¹æ³•çš„æ–¹æ³•åï¼Œè®¢é˜…çš„äº‹ä»¶ç±»å‹ï¼Œè§¦å‘çº¿ç¨‹ï¼Œæ˜¯å¦æ¥æ”¶stickyäº‹ä»¶ä»¥åŠä¼˜å…ˆçº§priorityã€‚è¿™å…¶ä¸­å°±ä¿å­˜äº†register()çš„æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ï¼Œå¦‚æœå†é…ç½®EventBusçš„æ—¶å€™é€šè¿‡<code>EventBusBuilder</code>é…ç½®ï¼š<code>eventBus = EventBus.builder().addIndex(new MyEventBusIndex()).build();</code>æ¥å°†ç¼–è¯‘ç”Ÿæˆçš„<code>MyEventBusIndex</code>é…ç½®è¿›å»ï¼Œè¿™æ ·å°±èƒ½åœ¨<code>SubscriberMethodFinder</code>ç±»ä¸­ç›´æ¥æŸ¥æ‰¾å‡ºè®¢é˜…ç±»çš„ä¿¡æ¯ï¼Œå°±ä¸éœ€è¦å†åˆ©ç”¨æ³¨è§£åˆ¤æ–­äº†ï¼Œå½“ç„¶è¿™ç§æ–¹æ³•æ˜¯ä½œä¸ºEventBusçš„å¯é€‰é…ç½®ï¼Œ<code>SubscriberMethodFinder</code>åŒæ ·æä¾›äº†é€šè¿‡æ³¨è§£æ¥è·å¾—è®¢é˜…ç±»ä¿¡æ¯çš„æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹<code>findSubscriberMethods()</code>åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">    <span class="comment">//å…ˆä»METHOD_CACHEå–çœ‹æ˜¯å¦æœ‰ç¼“å­˜, key:ä¿å­˜è®¢é˜…ç±»çš„ç±»å,value:ä¿å­˜ç±»ä¸­è®¢é˜…çš„æ–¹æ³•æ•°æ®,</span></div><div class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);</div><div class="line">    <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> subscriberMethods;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//æ˜¯å¦å¿½ç•¥æ³¨è§£å™¨ç”Ÿæˆçš„MyEventBusIndexç±»</span></div><div class="line">    <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</div><div class="line">        <span class="comment">//åˆ©ç”¨åå°„æ¥è¯»å–è®¢é˜…ç±»ä¸­çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">        subscriberMethods = findUsingReflection(subscriberClass);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//ä»æ³¨è§£å™¨ç”Ÿæˆçš„MyEventBusIndexç±»ä¸­è·å¾—è®¢é˜…ç±»çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">        subscriberMethods = findUsingInfo(subscriberClass);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</div><div class="line">                + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//ä¿å­˜è¿›METHOD_CACHEç¼“å­˜</span></div><div class="line">        METHOD_CACHE.put(subscriberClass, subscriberMethods);</div><div class="line">        <span class="keyword">return</span> subscriberMethods;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹çœ‹åˆ©ç”¨åå°„æ¥è¯»å–è®¢é˜…ç±»ä¸­çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯çš„å‡½æ•°ï¼š<code>findUsingReflection()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingReflection</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">    <span class="comment">//FindState ç”¨æ¥åšè®¢é˜…æ–¹æ³•çš„æ ¡éªŒå’Œä¿å­˜</span></div><div class="line">    FindState findState = prepareFindState();</div><div class="line">    findState.initForSubscriber(subscriberClass);</div><div class="line">    <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//é€šè¿‡åå°„æ¥è·å¾—è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">        findUsingReflectionInSingleClass(findState);</div><div class="line">        <span class="comment">//æŸ¥æ‰¾çˆ¶ç±»çš„è®¢é˜…æ–¹æ³•</span></div><div class="line">        findState.moveToSuperclass();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//è·å–findStateä¸­çš„SubscriberMethod(ä¹Ÿå°±æ˜¯è®¢é˜…æ–¹æ³•List)å¹¶è¿”å›</span></div><div class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥åŠä»æ³¨è§£å™¨ç”Ÿæˆçš„MyEventBusIndexç±»ä¸­è·å¾—è®¢é˜…ç±»çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯ï¼š <code>findUsingInfo()</code>ï¼š<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">    FindState findState = prepareFindState();</div><div class="line">    findState.initForSubscriber(subscriberClass);</div><div class="line">    <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//å¾—åˆ°è®¢é˜…è€…ä¿¡æ¯</span></div><div class="line">        findState.subscriberInfo = getSubscriberInfo(findState);</div><div class="line">        <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//éå†è®¢é˜…è€…æ–¹æ³•</span></div><div class="line">            SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</div><div class="line">            <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</div><div class="line">                <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</div><div class="line">                    findState.subscriberMethods.add(subscriberMethod);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰è®¢é˜…è€…ä¿¡æ¯å°±ä½¿ç”¨åå°„æŸ¥æ‰¾è®¢é˜…æ–¹æ³•</span></div><div class="line">            findUsingReflectionInSingleClass(findState);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//è·³è½¬åˆ°çˆ¶ç±»ä¸­ç»§ç»­æŸ¥æ‰¾</span></div><div class="line">        findState.moveToSuperclass();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿›å…¥åˆ°<code>getSubscriberInfo()</code> æ–¹æ³•ä¸­æˆ‘ä»¬çœ‹åˆ°äº†ä»è‡ªå®šä¹‰ç´¢å¼•Indexè·å–è®¢é˜…æ–¹æ³•ä¿¡æ¯çš„æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">    <span class="comment">//åˆ¤æ–­FindStateå¯¹è±¡ä¸­æ˜¯å¦æœ‰ç¼“å­˜çš„è®¢é˜…æ–¹æ³•</span></div><div class="line">    <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span> &amp;&amp; findState.subscriberInfo.getSuperSubscriberInfo() != <span class="keyword">null</span>) &#123;</div><div class="line">        SubscriberInfo superclassInfo = findState.subscriberInfo.getSuperSubscriberInfo();</div><div class="line">        <span class="keyword">if</span> (findState.clazz == superclassInfo.getSubscriberClass()) &#123;</div><div class="line">            <span class="keyword">return</span> superclassInfo;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ä»æ³¨è§£å™¨ç”Ÿæˆçš„MyEventBusIndexç±»ä¸­è·å¾—è®¢é˜…ç±»çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">    <span class="keyword">if</span> (subscriberInfoIndexes != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (SubscriberInfoIndex index : subscriberInfoIndexes) &#123;</div><div class="line">            SubscriberInfo info = index.getSubscriberInfo(findState.clazz);</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> info;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½œè€…ä½¿ç”¨äº†<code>FindState</code>ç±»æ¥åš<strong>è®¢é˜…æ–¹æ³•çš„æ ¡éªŒå’Œä¿å­˜</strong>ï¼Œå¹¶é€šè¿‡<code>FIND_STATE_POOL</code>é™æ€æ•°ç»„æ¥ä¿å­˜<code>FindState</code>å¯¹è±¡ï¼Œå¯ä»¥ä½¿<code>FindState</code>å¤ç”¨ï¼Œé¿å…é‡å¤åˆ›å»ºè¿‡å¤šçš„å¯¹è±¡ã€‚æœ€ç»ˆæ˜¯é€šè¿‡<code>findUsingReflectionInSingleClass()</code>æ¥å…·ä½“è·å¾—ç›¸å…³è®¢é˜…æ–¹æ³•çš„ä¿¡æ¯çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">//åœ¨è¾ƒæ–°çš„ç±»æ–‡ä»¶ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šæ·»åŠ æ–¹æ³•ã€‚é‚£äº›è¢«ç§°ä¸ºBRIDGEæˆ–SYNTHETICæ–¹æ³•ã€‚EventBuså¿…é¡»å¿½ç•¥ä¸¤è€…ã€‚æœ‰ä¿®é¥°ç¬¦æ²¡æœ‰å…¬å¼€ï¼Œä½†åœ¨Javaç±»æ–‡ä»¶ä¸­æœ‰æ ¼å¼å®šä¹‰</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BRIDGE = <span class="number">0x40</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYNTHETIC = <span class="number">0x1000</span>;</div><div class="line"><span class="comment">//éœ€è¦å¿½ç•¥çš„ä¿®é¥°ç¬¦</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODIFIERS_IGNORE = Modifier.ABSTRACT | Modifier.STATIC | BRIDGE | SYNTHETIC;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">    Method[] methods;</div><div class="line">    <span class="comment">//é€šè¿‡åå°„å¾—åˆ°æ–¹æ³•æ•°ç»„</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></div><div class="line">        methods = findState.clazz.getDeclaredMethods();</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">        <span class="comment">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span></div><div class="line">        methods = findState.clazz.getMethods();</div><div class="line">        findState.skipSuperClasses = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//éå†Method</span></div><div class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">        <span class="keyword">int</span> modifiers = method.getModifiers();</div><div class="line">        <span class="comment">//å¿…é¡»æ˜¯publicçš„æ–¹æ³•</span></div><div class="line">        <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">            Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">            <span class="comment">//ä¿è¯å¿…é¡»åªæœ‰ä¸€ä¸ªäº‹ä»¶å‚æ•°</span></div><div class="line">            <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">//å¾—åˆ°æ³¨è§£</span></div><div class="line">                Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);</div><div class="line">                <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">                    Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</div><div class="line">                    <span class="comment">//æ ¡éªŒæ˜¯å¦æ·»åŠ è¯¥æ–¹æ³•</span></div><div class="line">                    <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</div><div class="line">                        ThreadMode threadMode = subscribeAnnotation.threadMode();</div><div class="line">                        <span class="comment">//å®ä¾‹åŒ–SubscriberMethodå¯¹è±¡å¹¶æ·»åŠ </span></div><div class="line">                        findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</div><div class="line">                                subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</div><div class="line">                        <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">            String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</div><div class="line">                    <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…³äº <code>BRIDGE</code> å’Œ <code>SYNTHETIC</code> ï¼Œæ³¨é‡Šå†™é“ï¼š</p>
<blockquote>
<p>In newer class files, compilers may add methods. Those are called bridge or synthetic methods. EventBus must ignore both. There modifiers are not public but defined in the Java class file format: <a href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.6-200-A.1" target="_blank" rel="external">http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.6-200-A.1</a></p>
</blockquote>
<p>åœ¨è¾ƒæ–°çš„ç±»æ–‡ä»¶ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šæ·»åŠ æ–¹æ³•ã€‚é‚£äº›è¢«ç§°ä¸º BRIDGE æˆ– SYNTHETIC æ–¹æ³•ï¼ŒEventBus å¿…é¡»å¿½ç•¥ä¸¤è€…ã€‚æœ‰ä¿®é¥°ç¬¦æ²¡æœ‰å…¬å¼€ï¼Œä½†åœ¨ Java ç±»æ–‡ä»¶ä¸­æœ‰æ ¼å¼å®šä¹‰ã€‚</p>
<p>è¯¥<code>findUsingReflectionInSingleClass</code>æ–¹æ³•æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>æ‹¿åˆ°å½“å‰ class çš„æ‰€æœ‰æ–¹æ³•ï¼›</li>
<li>è¿‡æ»¤æ‰ä¸æ˜¯ public å’Œæ˜¯ abstractã€staticã€bridgeã€synthetic çš„æ–¹æ³•ï¼›</li>
<li>è¿‡æ»¤å‡ºæ–¹æ³•å‚æ•°åªæœ‰ä¸€ä¸ªçš„æ–¹æ³•ï¼›</li>
<li>è¿‡æ»¤å‡ºè¢«Subscribeæ³¨è§£ä¿®é¥°çš„æ–¹æ³•ï¼›</li>
<li>å°† method æ–¹æ³•å’Œ event äº‹ä»¶æ·»åŠ åˆ° <code>findState</code> ä¸­ï¼›</li>
<li>å°† EventBus å…³å¿ƒçš„ method æ–¹æ³•ã€event äº‹ä»¶ã€threadModeã€priorityã€sticky å°è£…æˆ <code>SubscriberMethod</code> å¯¹è±¡æ·»åŠ åˆ° <code>findState.subscriberMethods</code> åˆ—è¡¨ä¸­ï¼›</li>
</ol>
<p>è¿™é‡Œèµ°å®Œï¼Œæˆ‘ä»¬è®¢é˜…ç±»çš„æ‰€æœ‰<code>SubscriberMethod</code>éƒ½å·²ç»è¢«ä¿å­˜äº†ï¼Œæœ€åå†é€šè¿‡<code>getMethodsAndRelease()</code>è¿”å›<code>List&lt;SubscriberMethod&gt;</code>ã€‚è‡³æ­¤ï¼Œæ‰€æœ‰å…³äºå¦‚ä½•è·å¾—è®¢é˜…ç±»çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯å³ï¼š<code>SubscriberMethod</code>å¯¹è±¡å°±å·²ç»å®Œå…¨åˆ†æå®Œäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹<code>subscribe()</code>æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p><strong>subscribe()æ–¹æ³•çš„å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">//å¿…é¡»åœ¨åŒæ­¥ä»£ç å—é‡Œè°ƒç”¨</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</div><div class="line">    <span class="comment">//è·å–è®¢é˜…çš„äº‹ä»¶ç±»å‹</span></div><div class="line">    Class&lt;?&gt; eventType = subscriberMethod.eventType;</div><div class="line">    <span class="comment">//åˆ›å»ºSubscriptionå¯¹è±¡</span></div><div class="line">    Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod);</div><div class="line">    <span class="comment">//ä»subscriptionsByEventTypeé‡Œæ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¯¥Subscription,å¦‚æœæ·»åŠ è¿‡å°±æŠ›å‡ºå¼‚å¸¸,ä¹Ÿå°±æ˜¯æ¯ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå‡½æ•°å“åº”åŒä¸€ç§äº‹ä»¶ç±»å‹</span></div><div class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">    <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</div><div class="line">        subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">        subscriptionsByEventType.put(eventType, subscriptions);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></div><div class="line">                    + eventType);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ ¹æ®ä¼˜å…ˆçº§priorityæ¥æ·»åŠ Subscriptionå¯¹è±¡</span></div><div class="line">    <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</div><div class="line">            subscriptions.add(i, newSubscription);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//å°†è®¢é˜…è€…å¯¹è±¡ä»¥åŠè®¢é˜…çš„äº‹ä»¶ä¿å­˜åˆ°typesBySubscriberé‡Œ.</span></div><div class="line">    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</div><div class="line">    <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</div><div class="line">        subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        typesBySubscriber.put(subscriber, subscribedEvents);</div><div class="line">    &#125;</div><div class="line">    subscribedEvents.add(eventType);</div><div class="line">    <span class="comment">//å¦‚æœæ¥æ”¶stickyäº‹ä»¶,ç«‹å³åˆ†å‘stickyäº‹ä»¶</span></div><div class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</div><div class="line">        <span class="comment">//eventInheritance è¡¨ç¤ºæ˜¯å¦åˆ†å‘è®¢é˜…äº†å“åº”äº‹ä»¶ç±»çˆ¶ç±»äº‹ä»¶çš„æ–¹æ³•</span></div><div class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">            <span class="comment">// Existing sticky events of all subclasses of eventType have to be considered.</span></div><div class="line">            <span class="comment">// Note: Iterating over all events may be inefficient with lots of sticky events,</span></div><div class="line">            <span class="comment">// thus data structure should be changed to allow a more efficient lookup</span></div><div class="line">            <span class="comment">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span></div><div class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                    Object stickyEvent = entry.getValue();</div><div class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå°±æ˜¯æ‰€æœ‰æ³¨å†Œè¿‡ç¨‹ï¼Œç°åœ¨å†æ¥çœ‹è¿™å¼ å›¾å°±ä¼šç‰¹åˆ«æ¸…æ™°<code>EventBus</code>çš„<code>register()</code>è¿‡ç¨‹äº†:</p>
<p><img src="/gallery/EventBus/register-flow-chart.png" alt=""></p>
<p>åˆ°è¿™é‡Œï¼Œè®¢é˜…æµç¨‹å°±èµ°å®Œäº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨çœ‹äº‹ä»¶åˆ†å‘çš„æµç¨‹ã€‚</p>
<h4 id="2-3-å‘é€äº‹ä»¶Post"><a href="#2-3-å‘é€äº‹ä»¶Post" class="headerlink" title="2.3 å‘é€äº‹ä»¶Post"></a><strong>2.3 å‘é€äº‹ä»¶Post</strong></h4><p>æˆ‘ä»¬çŸ¥é“å‘é€äº‹ä»¶æ˜¯é€šè¿‡<code>post()</code> æ–¹æ³•è¿›è¡Œå¹¿æ’­çš„ï¼Œæ¯”å¦‚ç¬¬ä¸€èŠ‚æˆ‘ä»¬ä¾‹å­ä¸­æåˆ°çš„<code>EventBus.getDefault().post(new MessageEvent(&quot;Hello everyone!&quot;));</code> æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥è¿™ä¸ª<code>post()</code>æ–¹æ³•ä¸€çª¥ç©¶ç«Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">    <span class="comment">//å¾—åˆ°å½“å‰çº¿ç¨‹çš„PostingçŠ¶æ€.</span></div><div class="line">    PostingThreadState postingState = currentPostingThreadState.get();</div><div class="line">    <span class="comment">//è·å–å½“å‰çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—</span></div><div class="line">    List&lt;Object&gt; eventQueue = postingState.eventQueue;</div><div class="line">    eventQueue.add(event);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!postingState.isPosting) &#123;</div><div class="line">        <span class="comment">// è®°å½•å½“å‰å‘é€çº¿ç¨‹æ˜¯å¦ä¸ºä¸»çº¿ç¨‹</span></div><div class="line">        postingState.isMainThread = Looper.getMainLooper() == Looper.myLooper();</div><div class="line">        postingState.isPosting = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (postingState.canceled) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//å¤„ç†é˜Ÿåˆ—ï¼Œä¸€ç›´å‘é€å®Œæ‰€æœ‰äº‹ä»¶</span></div><div class="line">            <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</div><div class="line">                <span class="comment">//å‘é€å•ä¸ªäº‹ä»¶</span></div><div class="line">                postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            postingState.isPosting = <span class="keyword">false</span>;</div><div class="line">            postingState.isMainThread = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆæ˜¯é€šè¿‡<code>currentPostingThreadState.get()</code>æ–¹æ³•æ¥å¾—åˆ°å½“å‰çº¿ç¨‹<code>PostingThreadState</code>çš„å¯¹è±¡ï¼Œä¸ºä»€ä¹ˆæ˜¯è¯´å½“å‰çº¿ç¨‹ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹<code>currentPostingThreadState</code>çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;PostingThreadState&gt; currentPostingThreadState = <span class="keyword">new</span> ThreadLocal&lt;PostingThreadState&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> PostingThreadState <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PostingThreadState();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å…¶å®ç°æ˜¯è¿”å›ä¸€ä¸ª <code>PostingThreadState</code> å¯¹è±¡ï¼Œè€Œ <code>PostingThreadState</code> ç±»çš„ç»“æ„å¦‚ä¸‹ï¼Œå°è£…çš„æ˜¯å½“å‰çº¿ç¨‹çš„ post ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº‹ä»¶é˜Ÿåˆ—ã€æ˜¯å¦æ­£åœ¨åˆ†å‘ä¸­ã€æ˜¯å¦åœ¨ä¸»çº¿ç¨‹ã€è®¢é˜…è€…ä¿¡æ¯ã€äº‹ä»¶å®ä¾‹ã€æ˜¯å¦å–æ¶ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/** For ThreadLocal, much faster to set (and get multiple values). */</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PostingThreadState</span> </span>&#123;</div><div class="line">	<span class="keyword">final</span> List&lt;Object&gt; eventQueue = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line">    <span class="keyword">boolean</span> isPosting;</div><div class="line">    <span class="keyword">boolean</span> isMainThread;</div><div class="line">    Subscription subscription;</div><div class="line">    Object event;</div><div class="line">    <span class="keyword">boolean</span> canceled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»¼ä¸Šï¼Œ<code>currentPostingThreadState</code>çš„å®ç°æ˜¯ä¸€ä¸ªåŒ…å«äº†<code>PostingThreadState</code>çš„<code>ThreadLocal</code>å¯¹è±¡ï¼Œå…³äº<code>ThreadLocal</code><a href="http://kymjs.com/code/2015/12/16/01" target="_blank" rel="external">å¼ æ¶›çš„è¿™ç¯‡æ–‡ç« </a>è§£é‡Šçš„å¾ˆå¥½ï¼š<strong>ThreadLocal æ˜¯ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„æ•°æ®å­˜å‚¨ç±»ï¼Œé€šè¿‡å®ƒå¯ä»¥åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­å­˜å‚¨æ•°æ®ï¼Œè€Œè¿™æ®µæ•°æ®æ˜¯ä¸ä¼šä¸å…¶ä»–çº¿ç¨‹å…±äº«çš„ã€‚</strong> å…¶å†…éƒ¨åŸç†æ˜¯é€šè¿‡ç”Ÿæˆä¸€ä¸ªå®ƒåŒ…è£¹çš„æ³›å‹å¯¹è±¡çš„æ•°ç»„ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¼šæœ‰ä¸åŒçš„æ•°ç»„ç´¢å¼•å€¼ï¼Œé€šè¿‡è¿™æ ·å°±å¯ä»¥åšåˆ°æ¯ä¸ªçº¿ç¨‹é€šè¿‡<code>get()</code> æ–¹æ³•è·å–çš„æ—¶å€™ï¼Œå–åˆ°çš„åªèƒ½æ˜¯è‡ªå·±çº¿ç¨‹æ‰€å¯¹åº”çš„æ•°æ®ã€‚ æ‰€ä»¥è¿™é‡Œå–åˆ°çš„å°±æ˜¯æ¯ä¸ªçº¿ç¨‹çš„<code>PostingThreadState</code>çŠ¶æ€.æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹<code>postSingleEvent()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</div><div class="line">    Class&lt;?&gt; eventClass = event.getClass();</div><div class="line">    <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">//æ˜¯å¦è§¦å‘è®¢é˜…äº†è¯¥äº‹ä»¶(eventClass)çš„çˆ¶ç±»,ä»¥åŠæ¥å£çš„ç±»çš„å“åº”æ–¹æ³•</span></div><div class="line">    <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">        <span class="comment">//æŸ¥æ‰¾eventClassç±»æ‰€æœ‰çš„çˆ¶ç±»ä»¥åŠæ¥å£</span></div><div class="line">        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</div><div class="line">        <span class="keyword">int</span> countTypes = eventTypes.size();</div><div class="line">        <span class="comment">//å¾ªç¯postSingleEventForEventType</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</div><div class="line">            Class&lt;?&gt; clazz = eventTypes.get(h);</div><div class="line">            <span class="comment">//åªè¦å³è¾¹æœ‰ä¸€ä¸ªä¸ºtrue,subscriptionFoundå°±ä¸ºtrue</span></div><div class="line">            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//postå•ä¸ª</span></div><div class="line">        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//å¦‚æœæ²¡å‘ç°</span></div><div class="line">    <span class="keyword">if</span> (!subscriptionFound) &#123;</div><div class="line">        <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"No subscribers registered for event "</span> + eventClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;</div><div class="line">                eventClass != SubscriberExceptionEvent.class) &#123;</div><div class="line">            <span class="comment">//å‘é€ä¸€ä¸ªNoSubscriberEventäº‹ä»¶,å¦‚æœæˆ‘ä»¬éœ€è¦å¤„ç†è¿™ç§çŠ¶æ€,æ¥æ”¶è¿™ä¸ªäº‹ä»¶å°±å¯ä»¥äº†</span></div><div class="line">            post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>lookupAllEventTypes()</code> å°±æ˜¯æŸ¥æ‰¾è¯¥äº‹ä»¶çš„æ‰€æœ‰çˆ¶ç±»ï¼Œè¿”å›æ‰€æœ‰çš„è¯¥äº‹ä»¶çš„çˆ¶ç±»çš„ class ã€‚å®ƒé€šè¿‡å¾ªç¯å’Œé€’å½’ä¸€èµ·ç”¨ï¼Œå°†ä¸€ä¸ªç±»çš„çˆ¶ç±»ï¼ˆæ¥å£ï¼‰å…¨éƒ¨æ·»åŠ åˆ°å…¨å±€é™æ€å˜é‡ <code>eventTypes</code> é›†åˆä¸­ã€‚è·Ÿç€ä¸Šé¢çš„ä»£ç çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„å‘ç°æ˜¯åœ¨<code>postSingleEventForEventType()</code>æ–¹æ³•é‡Œå»è¿›è¡Œäº‹ä»¶çš„åˆ†å‘ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</div><div class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</div><div class="line">    <span class="comment">//è·å–è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶çš„Subscriptionåˆ—è¡¨.</span></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        subscriptions = subscriptionsByEventType.get(eventClass);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</div><div class="line">        <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</div><div class="line">            postingState.event = event;</div><div class="line">            postingState.subscription = subscription;</div><div class="line">            <span class="comment">//æ˜¯å¦è¢«ä¸­æ–­</span></div><div class="line">            <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//åˆ†å‘ç»™è®¢é˜…è€…</span></div><div class="line">                postToSubscription(subscription, event, postingState.isMainThread);</div><div class="line">                aborted = postingState.canceled;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                postingState.event = <span class="keyword">null</span>;</div><div class="line">                postingState.subscription = <span class="keyword">null</span>;</div><div class="line">                postingState.canceled = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (aborted) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</div><div class="line">    <span class="comment">//æ ¹æ®æ¥æ”¶è¯¥äº‹ä»¶çš„è®¢é˜…æ–¹æ³•çº¦å®šçš„ThreadModeå†³å®šåˆ†é…åˆ°å“ªä¸ªçº¿ç¨‹æ‰§è¡Œ</span></div><div class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</div><div class="line">        <span class="keyword">case</span> POSTING:</div><div class="line">            invokeSubscriber(subscription, event);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> MAIN:</div><div class="line">            <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mainThreadPoster.enqueue(subscription, event);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BACKGROUND:</div><div class="line">            <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                backgroundPoster.enqueue(subscription, event);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> ASYNC:</div><div class="line">            asyncPoster.enqueue(subscription, event);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸Šé¢çš„ä»£ç å°±æ˜¯,é¦–å…ˆä»<code>subscriptionsByEventType</code>é‡Œè·å¾—æ‰€æœ‰è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶çš„<code>Subscription</code>åˆ—è¡¨ï¼Œç„¶ååœ¨é€šè¿‡<code>postToSubscription()</code>æ–¹æ³•æ¥åˆ†å‘äº‹ä»¶ï¼Œåœ¨<code>postToSubscription()</code>é€šè¿‡ä¸åŒçš„<code>threadMode</code>åœ¨ä¸åŒçš„çº¿ç¨‹é‡Œ<code>invoke()</code>è®¢é˜…è€…çš„æ–¹æ³•,<code>ThreadMode</code>å…±æœ‰å››ç±»ï¼š</p>
<ol>
<li><code>PostThread</code>ï¼šé»˜è®¤çš„ ThreadModeï¼Œè¡¨ç¤ºåœ¨æ‰§è¡Œ Post æ“ä½œçš„çº¿ç¨‹ç›´æ¥è°ƒç”¨è®¢é˜…è€…çš„äº‹ä»¶å“åº”æ–¹æ³•ï¼Œä¸è®ºè¯¥çº¿ç¨‹æ˜¯å¦ä¸ºä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰ã€‚å½“è¯¥çº¿ç¨‹ä¸ºä¸»çº¿ç¨‹æ—¶ï¼Œå“åº”æ–¹æ³•ä¸­ä¸èƒ½æœ‰è€—æ—¶æ“ä½œï¼Œå¦åˆ™æœ‰å¡ä¸»çº¿ç¨‹çš„é£é™©ã€‚é€‚ç”¨åœºæ™¯ï¼š<strong>å¯¹äºæ˜¯å¦åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œæ— è¦æ±‚ï¼Œä½†è‹¥ Post çº¿ç¨‹ä¸ºä¸»çº¿ç¨‹ï¼Œä¸èƒ½è€—æ—¶çš„æ“ä½œ</strong>ï¼›</li>
<li><code>MainThread</code>ï¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œå“åº”æ–¹æ³•ã€‚å¦‚æœå‘å¸ƒçº¿ç¨‹å°±æ˜¯ä¸»çº¿ç¨‹ï¼Œåˆ™ç›´æ¥è°ƒç”¨è®¢é˜…è€…çš„äº‹ä»¶å“åº”æ–¹æ³•ï¼Œå¦åˆ™é€šè¿‡ä¸»çº¿ç¨‹çš„ Handler å‘é€æ¶ˆæ¯åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†â€”â€”è°ƒç”¨è®¢é˜…è€…çš„äº‹ä»¶å“åº”å‡½æ•°ã€‚æ˜¾ç„¶ï¼Œ<code>MainThread</code>ç±»çš„æ–¹æ³•ä¹Ÿä¸èƒ½æœ‰è€—æ—¶æ“ä½œï¼Œä»¥é¿å…å¡ä¸»çº¿ç¨‹ã€‚é€‚ç”¨åœºæ™¯ï¼š<strong>å¿…é¡»åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„æ“ä½œ</strong>ï¼›</li>
<li><code>BackgroundThread</code>ï¼šåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œå“åº”æ–¹æ³•ã€‚å¦‚æœå‘å¸ƒçº¿ç¨‹<strong>ä¸æ˜¯</strong>ä¸»çº¿ç¨‹ï¼Œåˆ™ç›´æ¥è°ƒç”¨è®¢é˜…è€…çš„äº‹ä»¶å“åº”å‡½æ•°ï¼Œå¦åˆ™å¯åŠ¨<strong>å”¯ä¸€çš„</strong>åå°çº¿ç¨‹å»å¤„ç†ã€‚ç”±äºåå°çº¿ç¨‹æ˜¯å”¯ä¸€çš„ï¼Œå½“äº‹ä»¶è¶…è¿‡ä¸€ä¸ªçš„æ—¶å€™ï¼Œå®ƒä»¬ä¼šè¢«æ”¾åœ¨é˜Ÿåˆ—ä¸­ä¾æ¬¡æ‰§è¡Œï¼Œå› æ­¤è¯¥ç±»å“åº”æ–¹æ³•è™½ç„¶æ²¡æœ‰<code>PostThread</code>ç±»å’Œ<code>MainThread</code>ç±»æ–¹æ³•å¯¹æ€§èƒ½æ•æ„Ÿï¼Œä½†æœ€å¥½ä¸è¦æœ‰é‡åº¦è€—æ—¶çš„æ“ä½œæˆ–å¤ªé¢‘ç¹çš„è½»åº¦è€—æ—¶æ“ä½œï¼Œä»¥é€ æˆå…¶ä»–æ“ä½œç­‰å¾…ã€‚é€‚ç”¨åœºæ™¯ï¼š<em>æ“ä½œè½»å¾®è€—æ—¶ä¸”ä¸ä¼šè¿‡äºé¢‘ç¹</em>ï¼Œå³ä¸€èˆ¬çš„è€—æ—¶æ“ä½œéƒ½å¯ä»¥æ”¾åœ¨è¿™é‡Œï¼›</li>
<li><code>Async</code>ï¼šä¸è®ºå‘å¸ƒçº¿ç¨‹æ˜¯å¦ä¸ºä¸»çº¿ç¨‹ï¼Œéƒ½ä½¿ç”¨ä¸€ä¸ªç©ºé—²çº¿ç¨‹æ¥å¤„ç†ã€‚å’Œ<code>BackgroundThread</code>ä¸åŒçš„æ˜¯ï¼Œ<code>Async</code>ç±»çš„æ‰€æœ‰çº¿ç¨‹æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤ä¸ä¼šå‡ºç°å¡çº¿ç¨‹çš„é—®é¢˜ã€‚é€‚ç”¨åœºæ™¯ï¼š<em>é•¿è€—æ—¶æ“ä½œï¼Œä¾‹å¦‚ç½‘ç»œè®¿é—®</em>ã€‚</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹çœ‹<code>invokeSubscriber(subscription, event);</code>æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</div><div class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">        handleSubscriberException(subscription, event, e.getCause());</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå°±æ˜¯é€šè¿‡åå°„è°ƒç”¨äº†è®¢é˜…è€…çš„è®¢é˜…å‡½æ•°å¹¶æŠŠ<code>event</code>å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ç„¶åæˆ‘ä»¬å°±åˆé‡åˆ°äº†åœ¨EventBusæ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„3ä¸ªPosterï¼š<strong>HandlerPoster</strong>ï¼ˆä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„mainThreadPosterå¯¹è±¡ï¼‰ ï¼Œ<strong>BackgroundPoster</strong>å’Œ<strong>AsyncPoster</strong>ï¼Œè¿™ 3 ä¸ª poster è´Ÿè´£çº¿ç¨‹é—´è°ƒåº¦ã€‚æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹çœ‹ï¼š</p>
<p><strong>#  HandlerPoster</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerPoster</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">	<span class="comment">//é˜Ÿåˆ—ï¼Œå³å°†æ‰§è¡Œçš„Post</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">  	<span class="comment">//ä¸€ä¸ªPostæœ€å¤§çš„åœ¨HandleMessageä¸­çš„æ—¶é—´</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxMillisInsideHandleMessage;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line">  	<span class="comment">//handleræ˜¯å¦è¿è¡Œèµ·æ¥äº†</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> handlerActive;</div><div class="line"></div><div class="line">    <span class="comment">//EventBusçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†mainThreadPoster = new HandlerPoster(this, Looper.getMainLooper(), 10);</span></div><div class="line">    <span class="comment">//æ³¨æ„æ­¤å¤„çš„Looper.getMainLooper()ä¾¿æŒ‡å®šäº†ä¸»çº¿ç¨‹çš„Looper</span></div><div class="line">    HandlerPoster(EventBus eventBus, Looper looper, <span class="keyword">int</span> maxMillisInsideHandleMessage) &#123;</div><div class="line">        <span class="keyword">super</span>(looper);</div><div class="line">        <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">        <span class="keyword">this</span>.maxMillisInsideHandleMessage = maxMillisInsideHandleMessage;</div><div class="line">        queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">      	<span class="comment">//PendingPostç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥å¤ç”¨PendingPostå¯¹è±¡çš„å¤ç”¨æ± </span></div><div class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">          	<span class="comment">//åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­</span></div><div class="line">            queue.enqueue(pendingPost);</div><div class="line">          	<span class="comment">//å¦‚æœhandleMessageæ²¡æœ‰è¿è¡Œèµ·æ¥</span></div><div class="line">            <span class="keyword">if</span> (!handlerActive) &#123;</div><div class="line">                handlerActive = <span class="keyword">true</span>;</div><div class="line">              	<span class="comment">//å‘é€ä¸€ä¸ªç©ºæ¶ˆæ¯ï¼Œè®©handleMessageè¿è¡Œèµ·æ¥</span></div><div class="line">                <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> rescheduled = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">long</span> started = SystemClock.uptimeMillis();</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">              	<span class="comment">//ä»é˜Ÿåˆ—ä¸­å–å‡ºPendingPost</span></div><div class="line">                PendingPost pendingPost = queue.poll();</div><div class="line">                <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                        <span class="comment">// Check again, this time in synchronized</span></div><div class="line">                        pendingPost = queue.poll();</div><div class="line">                        <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                            handlerActive = <span class="keyword">false</span>;</div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">              	<span class="comment">//è°ƒç”¨eventBusçš„æ–¹æ³•ï¼Œåˆ†å‘æ¶ˆæ¯</span></div><div class="line">                eventBus.invokeSubscriber(pendingPost);</div><div class="line">                <span class="keyword">long</span> timeInMethod = SystemClock.uptimeMillis() - started;</div><div class="line">              	<span class="comment">//å¦‚æœå†ä¸€å®šæ—¶é—´å†…éƒ½è¿˜æ²¡æœ‰å°†é˜Ÿåˆ—æ’ç©ºï¼Œåˆ™é€€å‡º</span></div><div class="line">                <span class="keyword">if</span> (timeInMethod &gt;= maxMillisInsideHandleMessage) &#123;</div><div class="line">                    <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</div><div class="line">                    &#125;</div><div class="line">                    rescheduled = <span class="keyword">true</span>;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            handlerActive = rescheduled;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æœ‰å¿…è¦å›çœ‹EventBusçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–äº†<code>mainThreadPoster = new HandlerPoster(this, Looper.getMainLooper(), 10);</code>çš„ä»£ç ã€‚æ³¨æ„è¿™è¡Œä»£ç ä¸­ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°<strong>Looper.getMainLooper()</strong>ä¾¿æŒ‡å®šäº†ä¸»çº¿ç¨‹çš„Looperï¼Œä¿è¯äº†è¿™ä¸ªHandlerPosterçš„è¿è¡Œåœ¨ä¸»çº¿ç¨‹ã€‚</p>
<p>ç„¶å<code>PendingPost</code> çš„æ•°æ®ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PendingPost</span> </span>&#123;</div><div class="line">    Object event;<span class="comment">//äº‹ä»¶</span></div><div class="line">    Subscription subscription;<span class="comment">//è®¢é˜…</span></div><div class="line">    PendingPost next;<span class="comment">//ä¸é˜Ÿåˆ—çš„æ•°æ®ç»“æ„æœ‰å…³ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>PendingPost</code> ç»´æŠ¤ç€ä¸€ä¸ªå¯ä»¥å¤ç”¨PendingPostå¯¹è±¡çš„å¤ç”¨æ± ï¼Œé€šè¿‡ <code>obtainPendingPost(Subscription, Object)</code> æ–¹æ³•å¤ç”¨ï¼Œé€šè¿‡ <code>releasePendingPost(PendingPost )</code> æ–¹æ³•å›æ”¶ã€‚</p>
<p><code>handleMessage()</code> ä¸­æœ‰ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè¿™ä¸ªæ­»å¾ªç¯ä¸åœçš„ä»é˜Ÿåˆ—ä¸­æ‹¿æ•°æ®ï¼Œç„¶åé€šè¿‡ <code>EventBus.invokeSubscriber()</code> åˆ†å‘å‡ºå»ã€‚æ¯åˆ†å‘å®Œä¸€æ¬¡æ¯”å¯¹ä¸€ä¸‹æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº† <code>maxMillisInsideHandleMessage</code> ï¼Œé‚£ä¹ˆå‘é€ç©º <code>message</code>å†æ¬¡è¿›å…¥åˆ° <code>handlerMessage</code> ä¸­ä¸”é€€å‡ºæœ¬æ¬¡å¾ªç¯ã€‚</p>
<p><strong># BackgroundPoster</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Posts events in background.</div><div class="line"> * <span class="doctag">@author</span> Markus</div><div class="line"> */</div><div class="line"> <span class="comment">//æˆ‘ä»¬æ³¨æ„åˆ°å®ƒå®ç°äº†Runableæ¥å£</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> executorRunning;</div><div class="line"></div><div class="line">    BackgroundPoster(EventBus eventBus) &#123;</div><div class="line">        <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">        queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="comment">//åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­</span></div><div class="line">            queue.enqueue(pendingPost);</div><div class="line">            <span class="keyword">if</span> (!executorRunning) &#123;</div><div class="line">                executorRunning = <span class="keyword">true</span>;</div><div class="line">                <span class="comment">//æŠŠè‡ªå·±è¿™ä¸ªRunableæŠ›å…¥çº¿ç¨‹æ± å¼€å§‹è¿è¡Œ</span></div><div class="line">                eventBus.getExecutorService().execute(<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                    <span class="comment">//ä»é˜Ÿåˆ—ä¸­å–å‡ºPendingPostï¼Œæ­¤å¤„çš„1000è¡¨ç¤ºå¦‚æœé˜Ÿåˆ—ä¸ºç©ºå°±æš‚åœ1000æ¯«ç§’å†å–</span></div><div class="line">                    PendingPost pendingPost = queue.poll(<span class="number">1000</span>);</div><div class="line">                    <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                            <span class="comment">// Check again, this time in synchronized</span></div><div class="line">                            pendingPost = queue.poll();</div><div class="line">                            <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                                executorRunning = <span class="keyword">false</span>;</div><div class="line">                                <span class="keyword">return</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//è°ƒç”¨eventBusçš„æ–¹æ³•ï¼Œåˆ†å‘æ¶ˆæ¯</span></div><div class="line">                    eventBus.invokeSubscriber(pendingPost);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                Log.w(<span class="string">"Event"</span>, Thread.currentThread().getName() + <span class="string">" was interruppted"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            executorRunning = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒç† <code>BackgroundPoster</code> ï¼Œåªä¸è¿‡ <code>HandlerPoster</code> æ˜¯åœ¨ <code>handlerMessage</code> ä¸­è¿›è¡Œåˆ†å‘æ“ä½œï¼Œè€Œ <code>BackgroundPoster</code> æ˜¯åœ¨ <code>Runnable</code> çš„ <code>run</code> æ–¹æ³•ä¸­å°†æ‰€æœ‰é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å–å‡ºè¿›è¡Œåˆ†å‘ï¼Œç›´åˆ°å–å®Œä¸ºæ­¢ã€‚</p>
<p><strong># AsyncPoster</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Posts events in background.</div><div class="line"> * <span class="doctag">@author</span> Markus</div><div class="line"> */</div><div class="line"> <span class="comment">//å®ƒä¹Ÿå®ç°Runableæ¥å£</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line"></div><div class="line">    AsyncPoster(EventBus eventBus) &#123;</div><div class="line">        <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">        queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">        queue.enqueue(pendingPost);</div><div class="line">        eventBus.getExecutorService().execute(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        PendingPost pendingPost = queue.poll();</div><div class="line">        <span class="keyword">if</span>(pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No pending post available"</span>);</div><div class="line">        &#125;</div><div class="line">        eventBus.invokeSubscriber(pendingPost);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œ <code>AsyncPoster</code> è™½ç„¶ä¹Ÿæ˜¯åœ¨ <code>Runnable</code> çš„ <code>run</code> æ–¹æ³•ä¸­å–å‡ºé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œä½†æ˜¯åªå–ä¸€ä¸ªã€‚ä¸è®ºå‘å¸ƒçº¿ç¨‹æ˜¯å¦ä¸ºä¸»çº¿ç¨‹ï¼Œéƒ½ä½¿ç”¨ä¸€ä¸ªç©ºé—²çº¿ç¨‹æ¥å¤„ç†ã€‚å’Œ<code>BackgroundThread</code>ä¸åŒçš„æ˜¯ï¼Œ<code>Async</code>ç±»çš„æ‰€æœ‰çº¿ç¨‹æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤ä¸ä¼šå‡ºç°å¡çº¿ç¨‹çš„é—®é¢˜ã€‚é€‚ç”¨åœºæ™¯ï¼š<em>é•¿è€—æ—¶æ“ä½œï¼Œä¾‹å¦‚ç½‘ç»œè®¿é—®</em>ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒçš„Posterä¼šåœ¨postäº‹ä»¶æ—¶ï¼Œè°ƒåº¦ç›¸åº”çš„äº‹ä»¶é˜Ÿåˆ—PendingPostQueueï¼Œè®©æ¯ä¸ªè®¢é˜…è€…çš„å›è°ƒæ–¹æ³•æ”¶åˆ°ç›¸åº”çš„äº‹ä»¶ï¼Œå¹¶åœ¨å…¶æ³¨å†Œçš„Threadä¸­è¿è¡Œã€‚è€Œè¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œç”±ä¸€ä¸ªä¸ªPendingPostç»„æˆï¼Œå…¶ä¸­åŒ…å«äº†äº‹ä»¶ï¼Œäº‹ä»¶è®¢é˜…è€…ï¼Œå›è°ƒæ–¹æ³•è¿™ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°ï¼Œä»¥åŠéœ€è¦æ‰§è¡Œçš„ä¸‹ä¸€ä¸ªPendingPostã€‚è‡³æ­¤<code>post()</code>æµç¨‹å°±ç»“æŸäº†ï¼Œæ•´ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/gallery/EventBus/post-flow-chart.png" alt=""></p>
<h4 id="2-4-è§£é™¤æ³¨å†ŒUnregister"><a href="#2-4-è§£é™¤æ³¨å†ŒUnregister" class="headerlink" title="2.4 è§£é™¤æ³¨å†ŒUnregister"></a>2.4 è§£é™¤æ³¨å†ŒUnregister</h4><p>çœ‹å®Œäº†ä¸Šé¢çš„åˆ†æï¼Œè§£é™¤æ³¨å†Œå°±ç›¸å¯¹å®¹æ˜“äº†ï¼Œè§£é™¤æ³¨å†Œåªè¦è°ƒç”¨<code>unregister()</code>æ–¹æ³•å³å¯ã€‚å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">    <span class="comment">//é€šè¿‡typesBySubscriberæ¥å–å‡ºè¿™ä¸ªsubscriberè®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶ç±»å‹,</span></div><div class="line">    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);</div><div class="line">    <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//åˆ†åˆ«è§£é™¤æ¯ä¸ªè®¢é˜…äº†çš„äº‹ä»¶ç±»å‹</span></div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;</div><div class="line">            unsubscribeByEventType(subscriber, eventType);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//ä»typesBySubscriberç§»é™¤subscriber</span></div><div class="line">        typesBySubscriber.remove(subscriber);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Log.w(TAG, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæ¥ç€çœ‹<code>unsubscribeByEventType()</code>æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</div><div class="line">    <span class="comment">//subscriptionsByEventTypeé‡Œæ‹¿å‡ºè¿™ä¸ªäº‹ä»¶ç±»å‹çš„è®¢é˜…è€…åˆ—è¡¨.</span></div><div class="line">    List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">        <span class="comment">//å–æ¶ˆè®¢é˜…</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">            Subscription subscription = subscriptions.get(i);</div><div class="line">            <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</div><div class="line">                subscription.active = <span class="keyword">false</span>;</div><div class="line">                subscriptions.remove(i);</div><div class="line">                i--;</div><div class="line">                size--;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆåˆ†åˆ«ä»<code>typesBySubscriber</code>å’Œ<code>subscriptions</code>é‡Œåˆ†åˆ«ç§»é™¤è®¢é˜…è€…ä»¥åŠç›¸å…³ä¿¡æ¯å³å¯ã€‚</p>
<h3 id="ä¸‰ã€EventBusåŸç†åˆ†æ"><a href="#ä¸‰ã€EventBusåŸç†åˆ†æ" class="headerlink" title="ä¸‰ã€EventBusåŸç†åˆ†æ"></a>ä¸‰ã€EventBusåŸç†åˆ†æ</h3><p>åœ¨å¹³æ—¶ä½¿ç”¨ä¸­æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒEventBusä¸­å¯¹äº‹ä»¶çš„åˆ†å‘æœºåˆ¶ï¼Œä½†è¦æˆä¸ºèƒ½å¤Ÿå¿«é€Ÿæ’æŸ¥é—®é¢˜çš„è€å¸æœºï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—ç†Ÿæ‚‰å®ƒçš„å·¥ä½œåŸç†ï¼Œä¸‹é¢æˆ‘ä»¬å°±é€è¿‡UMLå›¾æ¥å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<h4 id="3-1-æ ¸å¿ƒæ¶æ„"><a href="#3-1-æ ¸å¿ƒæ¶æ„" class="headerlink" title="3.1 æ ¸å¿ƒæ¶æ„"></a>3.1 æ ¸å¿ƒæ¶æ„</h4><p>EventBusçš„æ ¸å¿ƒå·¥ä½œæœºåˆ¶é€è¿‡ä½œè€…Blogä¸­çš„è¿™å¼ å›¾å°±èƒ½å¾ˆå¥½åœ°ç†è§£ï¼š</p>
<p><img src="/gallery/EventBus/eventbus_overview.png" alt=""></p>
<p>è®¢é˜…è€…æ¨¡å—éœ€è¦é€šè¿‡EventBusè®¢é˜…ç›¸å…³çš„äº‹ä»¶ï¼Œå¹¶å‡†å¤‡å¥½å¤„ç†äº‹ä»¶çš„å›è°ƒæ–¹æ³•ï¼Œè€Œäº‹ä»¶å‘å¸ƒè€…åˆ™åœ¨é€‚å½“çš„æ—¶æœºæŠŠäº‹ä»¶postå‡ºå»ï¼ŒEventBuså°±èƒ½å¸®æˆ‘ä»¬æå®šä¸€åˆ‡ã€‚åœ¨æ¶æ„æ–¹é¢ï¼ŒEventBus 3.0ä¸ä¹‹å‰ç¨è€ç‰ˆæœ¬æœ‰ä¸åŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹æ¶æ„å›¾ï¼š</p>
<p><img src="/gallery/EventBus/class_overview.png" alt="EventBus 3.0æ¶æ„å›¾"></p>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£æˆ–è€…å¯¹æ¯”ï¼Œé¡ºä¾¿ä¹Ÿæ”¾ä¸€å¼ 2.xè€ç‰ˆæœ¬çš„ç»“æ„å›¾å§ï¼š</p>
<p><img src="/gallery/EventBus/class-relation.png" alt="EventBus 2.xè€ç‰ˆæœ¬ç»“æ„å›¾"></p>
<p>è™½ç„¶æ›´æ–°äº†3.0ï¼Œä½†æ˜¯æ•´ä½“ä¸Šçš„è®¾è®¡è¿˜æ˜¯å¯ä»¥ç”¨ä¸Šé¢çš„ç±»å›¾æ¥åˆ†æï¼Œä»ç±»å›¾ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤§éƒ¨åˆ†ç±»éƒ½æ˜¯ä¾èµ–äºEventBusçš„ï¼Œä¸Šéƒ¨åˆ†ä¸»è¦æ˜¯è®¢é˜…è€…ç›¸å…³ä¿¡æ¯ï¼Œä¸­é—´æ˜¯ EventBus ç±»ï¼Œä¸‹é¢æ˜¯å‘å¸ƒè€…å‘å¸ƒäº‹ä»¶åçš„è°ƒç”¨ã€‚</p>
<p>æ ¹æ®UMLå›¾ï¼Œæˆ‘ä»¬å…ˆçœ‹æ ¸å¿ƒç±»EventBusï¼Œå…¶ä¸­<code>subscriptionByEventType</code>æ˜¯ä»¥äº‹ä»¶çš„ç±»ä¸ºkeyï¼Œè®¢é˜…è€…çš„å›è°ƒæ–¹æ³•ä¸ºvalueçš„æ˜ å°„å…³ç³»è¡¨ã€‚ä¹Ÿå°±æ˜¯è¯´EventBusåœ¨æ”¶åˆ°ä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œå°±å¯ä»¥æ ¹æ®è¿™ä¸ªäº‹ä»¶çš„ç±»å‹ï¼Œåœ¨<code>subscriptionByEventType</code>ä¸­æ‰¾åˆ°æ‰€æœ‰ç›‘å¬äº†è¯¥äº‹ä»¶çš„è®¢é˜…è€…åŠå¤„ç†äº‹ä»¶çš„å›è°ƒæ–¹æ³•ã€‚è€Œ<code>typesBySubscriber</code>åˆ™æ˜¯æ¯ä¸ªè®¢é˜…è€…æ‰€ç›‘å¬çš„äº‹ä»¶ç±»å‹è¡¨ï¼Œåœ¨å–æ¶ˆæ³¨å†Œæ—¶å¯ä»¥é€šè¿‡è¯¥è¡¨ä¸­ä¿å­˜çš„ä¿¡æ¯ï¼Œå¿«é€Ÿåˆ é™¤<code>subscriptionByEventType</code>ä¸­è®¢é˜…è€…çš„æ³¨å†Œä¿¡æ¯ï¼Œé¿å…éå†æŸ¥æ‰¾ã€‚æ³¨å†Œäº‹ä»¶ã€å‘é€äº‹ä»¶å’Œæ³¨é”€éƒ½æ˜¯å›´ç»•ç€è¿™ä¸¤ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„æ¥å±•å¼€ã€‚ä¸Šé¢çš„Subscriptionå¯ä»¥ç†è§£ä¸ºæ¯ä¸ªè®¢é˜…è€…ä¸å›è°ƒæ–¹æ³•çš„å…³ç³»ï¼Œåœ¨å…¶ä»–æ¨¡å—å‘é€äº‹ä»¶æ—¶ï¼Œå°±ä¼šé€šè¿‡è¿™ä¸ªå…³ç³»ï¼Œè®©è®¢é˜…è€…æ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚</p>
<p>å›è°ƒæ–¹æ³•åœ¨è¿™é‡Œè¢«å°è£…æˆäº†<code>SubscriptionMethod</code>ï¼Œé‡Œé¢ä¿å­˜äº†åœ¨éœ€è¦åå°„invokeæ–¹æ³•æ—¶çš„å„ç§å‚æ•°ï¼ŒåŒ…æ‹¬ä¼˜å…ˆçº§ï¼Œæ˜¯å¦æ¥æ”¶é»æ€§äº‹ä»¶å’Œæ‰€åœ¨çº¿ç¨‹ç­‰ä¿¡æ¯ã€‚è€Œè¦ç”Ÿæˆè¿™äº›å°è£…å¥½çš„æ–¹æ³•ï¼Œåˆ™éœ€è¦<code>SubscriberMethodFinder</code>ï¼Œå®ƒå¯ä»¥åœ¨regsteræ—¶å¾—åˆ°è®¢é˜…è€…çš„æ‰€æœ‰å›è°ƒæ–¹æ³•ï¼Œå¹¶å°è£…è¿”å›ç»™EventBusã€‚è€Œå³è¾¹çš„åŠ é€Ÿå™¨æ¨¡å—ï¼Œå°±æ˜¯ä¸ºäº†æé«˜<code>SubscriberMethodFinder</code>çš„æ•ˆç‡ï¼Œè¿™é‡Œå°±ä¸å†å•°å—¦ã€‚</p>
<p>è‡³æ­¤EventBus 3.0çš„æ¶æ„å°±åˆ†æå®Œäº†ï¼Œä¸ä¹‹å‰EventBusè€ç‰ˆæœ¬æœ€æ˜æ˜¾çš„åŒºåˆ«åœ¨äºï¼šåˆ†å‘äº‹ä»¶çš„è°ƒåº¦å•ä½ä»è®¢é˜…è€…ï¼Œç»†åŒ–æˆäº†è®¢é˜…è€…çš„å›è°ƒæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªå›è°ƒæ–¹æ³•éƒ½æœ‰è‡ªå·±çš„ä¼˜å…ˆçº§ï¼Œæ‰§è¡Œçº¿ç¨‹å’Œæ˜¯å¦æ¥æ”¶é»æ€§äº‹ä»¶ï¼Œæé«˜äº†äº‹ä»¶åˆ†å‘çš„çµæ´»ç¨‹åº¦ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨çœ‹æ ¸å¿ƒåŠŸèƒ½çš„å®ç°æ—¶æ›´èƒ½ä½“ç°è¿™ä¸€ç‚¹ã€‚</p>
<h4 id="3-2-register"><a href="#3-2-register" class="headerlink" title="3.2 register"></a>3.2 register</h4><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼šæ ¹æ®è®¢é˜…è€…çš„ç±»æ¥æ‰¾å›è°ƒæ–¹æ³•ï¼ŒæŠŠè®¢é˜…è€…å’Œå›è°ƒæ–¹æ³•å°è£…æˆå…³ç³»ï¼Œå¹¶ä¿å­˜åˆ°ç›¸åº”çš„æ•°æ®ç»“æ„ä¸­ï¼Œä¸ºéšåçš„äº‹ä»¶åˆ†å‘åšå¥½å‡†å¤‡ï¼Œæœ€åå¤„ç†é»æ€§äº‹ä»¶ã€‚</p>
<p><img src="/gallery/EventBus/register.png" alt="æ³¨å†Œè®¢é˜…æµç¨‹"></p>
<ol>
<li>æ ¹æ®è®¢é˜…è€…æ¥æ‰¾åˆ°è®¢é˜…æ–¹æ³•å’Œäº‹ä»¶ï¼Œå°è£…æˆ <code>SubscriberMehod</code></li>
<li>å¾ªç¯æ¯ä¸ª <code>SubscriberMethod</code></li>
<li>é€šè¿‡äº‹ä»¶å¾—åˆ°è¯¥äº‹ä»¶çš„æ‰€æœ‰è®¢é˜…è€…åˆ—è¡¨ï¼Œå†æ ¹æ®ä¼˜å…ˆçº§æ’å…¥åˆ° <code>subscriptionsByEventType</code> çš„æ‰€æœ‰è®¢é˜…è€…åˆ—è¡¨ä¸­</li>
<li>é€šè¿‡è®¢é˜…è€…å¾—åˆ°è¯¥è®¢é˜…è€…çš„æ‰€æœ‰äº‹ä»¶åˆ—è¡¨ï¼Œå†å°†äº‹ä»¶æ·»åŠ åˆ° <code>typeBySubscriber</code> çš„æ‰€ä»¥äº‹ä»¶åˆ—è¡¨ä¸­</li>
<li>æ˜¯å¦æ˜¯ç²˜æ€§äº‹ä»¶</li>
<li>æ˜¯çš„è¯è¿›è¡Œåˆ†å‘ï¼Œpostæ­¤äº‹ä»¶ç»™å½“å‰è®¢é˜…è€…ï¼Œä¸æ˜¯çš„è¯ä¸ç®¡</li>
<li>ç»“æŸæœ¬æ¬¡å¾ªç¯ï¼Œè·³åˆ° 2</li>
</ol>
<h4 id="3-3-post"><a href="#3-3-post" class="headerlink" title="3.3 post"></a>3.3 post</h4><p>æ€»çš„æ¥è¯´å°±æ˜¯åˆ†æäº‹ä»¶ï¼Œå¾—åˆ°æ‰€æœ‰ç›‘å¬è¯¥äº‹ä»¶çš„è®¢é˜…è€…çš„å›è°ƒæ–¹æ³•ï¼Œå¹¶åˆ©ç”¨åå°„æ¥invokeæ–¹æ³•ï¼Œå®ç°å›è°ƒã€‚</p>
<p><img src="/gallery/EventBus/post.png" alt="å‘é€æµç¨‹"></p>
<ol>
<li>ä» <code>currentPostingThreadState</code> ä¸­å¾—åˆ°å½“å‰çº¿ç¨‹çš„ <code>PostThreadState</code> ä¿¡æ¯</li>
<li>å°†æ­¤äº‹ä»¶æ·»åŠ åˆ° <code>PostPostThreadState</code> çš„äº‹ä»¶é˜Ÿåˆ—ä¸­</li>
<li>åˆ¤æ–­æ˜¯å¦å†åˆ†å‘</li>
<li>ä¸æ˜¯çš„è¯ï¼Œå¾ªç¯é˜Ÿåˆ—ï¼Œæ˜¯çš„è¯è·³ 7</li>
<li>åˆ¤æ–­æ˜¯ä¸ªéœ€è¦ç»§æ‰¿å…³ç³»</li>
<li>æ˜¯çš„è¯ï¼Œå¾ªç¯å¾—åˆ°çˆ¶ç±»ï¼Œä¸æ˜¯çš„è¯è·³ 7</li>
<li>æŸ¥æ‰¾è¯¥äº‹ä»¶çš„è®¢é˜…è€…ï¼Œå¾ªç¯è®¢é˜…è€…</li>
<li>æ ¹æ® <code>ThreadMoth</code> å‘é€äº‹ä»¶</li>
<li>ç»“æŸæœ¬æ¬¡å¾ªç¯è®¢é˜…è€…ï¼Œè·³ 7</li>
<li>ç»“æŸæœ¬æ¬¡å¾ªç¯é˜Ÿåˆ—ï¼Œè·³ 4</li>
</ol>
<p>åœ¨æºä»£ç ä¸­ä¸ºäº†ä¿è¯postæ‰§è¡Œä¸ä¼šå‡ºç°æ­»é”ï¼Œç­‰å¾…å’Œå¯¹åŒä¸€è®¢é˜…è€…å‘é€ç›¸åŒçš„äº‹ä»¶ï¼Œå¢åŠ äº†å¾ˆå¤šçº¿ç¨‹ä¿æŠ¤é”å’Œæ ‡å¿—ä½ï¼Œå€¼å¾—æˆ‘ä»¬æ¯ä¸ªå¼€å‘è€…å­¦ä¹ ã€‚</p>
<h4 id="3-4-unregister"><a href="#3-4-unregister" class="headerlink" title="3.4 unregister"></a>3.4 unregister</h4><p>æ³¨é”€å°±æ¯”è¾ƒç®€å•äº†ï¼ŒæŠŠåœ¨æ³¨å†Œæ—¶å¾€ä¸¤ä¸ªæ•°æ®ç»“æ„ä¸­æ·»åŠ çš„è®¢é˜…è€…ä¿¡æ¯åˆ é™¤å³å¯ï¼š</p>
<p><img src="/gallery/EventBus/unregister.png" alt="æ³¨é”€æµç¨‹"></p>
<p>è‡³æ­¤å¤§å®¶å¯¹EventBusçš„è¿è¡ŒåŸç†åº”è¯¥æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œè™½ç„¶çœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªå¤æ‚è€—æ—¶çš„è‡ªåŠ¨æœºï¼Œä½†å¤§éƒ¨åˆ†æ—¶å€™äº‹ä»¶éƒ½æ˜¯ä¸€ç¬é—´å°±èƒ½åˆ†å‘åˆ°ä½çš„ï¼Œè€Œå¤§å®¶å…³å¿ƒçš„æ€§èƒ½é—®é¢˜åè€Œæ˜¯å‘ç”Ÿåœ¨æ³¨å†ŒEventBusçš„æ—¶å€™ï¼Œå› ä¸ºéœ€è¦éå†ç›‘å¬è€…çš„æ‰€æœ‰æ–¹æ³•å»æ‰¾åˆ°å›è°ƒçš„æ–¹æ³•ã€‚ä½œè€…ä¹Ÿæåˆ°è¿è¡Œæ—¶æ³¨è§£çš„æ€§èƒ½åœ¨Androidä¸Šå¹¶ä¸ç†æƒ³ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½œè€…æ‰ä¼šä»¥ç´¢å¼•çš„æ–¹å¼å»ç”Ÿæˆå›è°ƒæ–¹æ³•è¡¨ï¼Œä¹Ÿå°±æ˜¯åœ¨EventBus 3.0ä¸­å¼•å…¥äº†<strong>EventBusAnnotationProcessor</strong>ï¼ˆæ³¨è§£åˆ†æç”Ÿæˆç´¢å¼•ï¼‰æŠ€æœ¯ï¼Œå¤§å¤§æé«˜äº†EventBusçš„è¿è¡Œæ•ˆç‡ã€‚å…³äºç´¢å¼•æŠ€æœ¯çš„æºç åˆ†æï¼Œå¤§å®¶å¯ä»¥å‚è€ƒè…¾è®¯Buglyçš„è¿™è¾¹æ–‡ç« ï¼š<a href="https://segmentfault.com/a/1190000005089229" target="_blank" rel="external">è€å¸æœºæ•™ä½  â€œé£™â€ EventBus 3</a> ã€‚</p>
<h3 id="å››ã€ç¼ºç‚¹ä¸é—®é¢˜"><a href="#å››ã€ç¼ºç‚¹ä¸é—®é¢˜" class="headerlink" title="å››ã€ç¼ºç‚¹ä¸é—®é¢˜"></a>å››ã€ç¼ºç‚¹ä¸é—®é¢˜</h3><p>ä¸€ç›´ä»¥æ¥ï¼ŒEventBusè¢«å¤§å®¶åæ§½çš„ä¸€å¤§é—®é¢˜å°±æ˜¯ä»£ç æ··æ·†é—®é¢˜ã€‚</p>
<h4 id="4-1-æ··æ·†é—®é¢˜"><a href="#4-1-æ··æ·†é—®é¢˜" class="headerlink" title="4.1 æ··æ·†é—®é¢˜"></a>4.1 æ··æ·†é—®é¢˜</h4><p>æ··æ·†ä½œä¸ºç‰ˆæœ¬å‘å¸ƒå¿…å¤‡çš„æµç¨‹ï¼Œç»å¸¸ä¼šé—¹å‡ºå¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œä¸”ä¸æ–¹ä¾¿å®šä½ï¼Œå°¤å…¶æ˜¯EventBusè¿™ç§ä¾èµ–åå°„æŠ€æœ¯çš„åº“ã€‚é€šå¸¸æƒ…å†µä¸‹éƒ½ä¼šæŠŠç›¸å…³çš„ç±»å’Œå›è°ƒæ–¹æ³•éƒ½keepä½ï¼Œä½†è¿™æ ·å…¶å®ä¼šç•™ä¸‹è¢«äººåç¼–è¯‘åç ´è§£çš„åé¡¾ä¹‹å¿§ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡æ˜¯keepæœ€å°‘çš„ä»£ç ã€‚</p>
<p>é¦–å…ˆï¼Œå› ä¸ºEventBus 3å¼ƒç”¨äº†åå°„çš„æ–¹å¼å»å¯»æ‰¾å›è°ƒæ–¹æ³•ï¼Œæ”¹ç”¨æ³¨è§£çš„æ–¹å¼ã€‚ä½œè€…çš„æ„æ€æ˜¯åœ¨æ··æ·†æ—¶å°±ä¸ç”¨å†keepä½ç›¸åº”çš„ç±»å’Œæ–¹æ³•ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¿è¡Œæ—¶ï¼Œå´ä¼šæŠ¥<code>java.lang.NoSuchFieldError: No static field POSTING</code>ã€‚ç½‘ä¸Šç»™å‡ºçš„è§£å†³åŠæ³•æ˜¯keepä½æ‰€æœ‰eventbusç›¸å…³çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">-keep <span class="class"><span class="keyword">class</span> <span class="title">de</span>.<span class="title">greenrobot</span>.** </span>&#123;*;&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®æˆ‘ä»¬ä»”ç»†åˆ†æï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å› ä¸ºåœ¨SubscriberMethodFinderçš„findUsingReflectionæ–¹æ³•ä¸­ï¼Œåœ¨è°ƒç”¨Method.getAnnotation()æ—¶è·å–ThreadModeè¿™ä¸ªenumå¤±è´¥äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦keepä½è¿™ä¸ªenumå°±å¯ä»¥äº†ï¼ˆå¦‚ä¸‹ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">-keep <span class="keyword">public</span> <span class="keyword">enum</span> org.greenrobot.eventbus.ThreadMode &#123; <span class="keyword">public</span> <span class="keyword">static</span> *; &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±èƒ½æ­£å¸¸ç¼–è¯‘é€šè¿‡äº†ï¼Œä½†å¦‚æœä½¿ç”¨äº†ç´¢å¼•åŠ é€Ÿï¼Œæ˜¯ä¸ä¼šæœ‰ä¸Šé¢è¿™ä¸ªé—®é¢˜çš„ã€‚å› ä¸ºåœ¨æ‰¾æ–¹æ³•æ—¶ï¼Œè°ƒç”¨çš„ä¸æ˜¯findUsingReflectionï¼Œè€Œæ˜¯findUsingInfoã€‚ä½†æ˜¯ä½¿ç”¨äº†ç´¢å¼•åŠ é€Ÿåï¼Œç¼–è¯‘åå´ä¼šæŠ¥æ–°çš„é”™è¯¯ï¼š<code>Could not find subscriber method in XXX Class. Maybe a missing ProGuard rule?</code></p>
<p>è¿™å°±å¾ˆå¥½ç†è§£äº†ï¼Œå› ä¸ºç”Ÿæˆç´¢å¼•GeneratedSubscriberIndexæ˜¯åœ¨ä»£ç æ··æ·†ä¹‹å‰è¿›è¡Œçš„ï¼Œæ··æ·†ä¹‹åç±»åå’Œæ–¹æ³•åéƒ½ä¸ä¸€æ ·äº†ï¼ˆä¸Šé¢è¿™ä¸ªé”™è¯¯æ˜¯æ–¹æ³•æ— æ³•æ‰¾åˆ°ï¼‰ï¼Œå¾—keepä½æ‰€æœ‰è¢«Subscribeæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">-keepclassmembers <span class="class"><span class="keyword">class</span> * </span>&#123;</div><div class="line">    <span class="meta">@de</span>.greenrobot.event.Subscribe &lt;methods&gt;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥åˆå€’é€€å›äº†EventBus2.4æ—¶ä¸èƒ½æ··æ·†onEventå¼€å¤´çš„æ–¹æ³•ä¸€æ ·çš„å¤„å¢ƒäº†ã€‚æ‰€ä»¥è¿™é‡Œå°±å¾—æƒè¡¡ä¸€ä¸‹åˆ©å¼Šï¼šä½¿ç”¨äº†æ³¨è§£ä¸ç”¨ç´¢å¼•åŠ é€Ÿï¼Œåˆ™åªéœ€è¦keepä½EventBusç›¸å…³çš„ä»£ç ï¼Œç°æœ‰çš„ä»£ç å¯ä»¥æ­£å¸¸çš„è¿›è¡Œæ··æ·†ã€‚è€Œä½¿ç”¨äº†ç´¢å¼•åŠ é€Ÿçš„è¯ï¼Œåˆ™éœ€è¦keepä½ç›¸å…³çš„æ–¹æ³•å’Œç±»ã€‚</p>
<h4 id="4-2-è·¨è¿›ç¨‹é—®é¢˜"><a href="#4-2-è·¨è¿›ç¨‹é—®é¢˜" class="headerlink" title="4.2 è·¨è¿›ç¨‹é—®é¢˜"></a>4.2 è·¨è¿›ç¨‹é—®é¢˜</h4><p>ç›®å‰EventBusåªæ”¯æŒè·¨çº¿ç¨‹ï¼Œè€Œ<strong>ä¸æ”¯æŒè·¨è¿›ç¨‹</strong>ã€‚å¦‚æœä¸€ä¸ªappçš„serviceèµ·åˆ°äº†å¦ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆæ³¨å†Œç›‘å¬çš„æ¨¡å—åˆ™ä¼šæ”¶ä¸åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„EventBuså‘å‡ºçš„äº‹ä»¶ã€‚è¿™é‡Œå¯ä»¥è€ƒè™‘åˆ©ç”¨IPCåšæ˜ å°„è¡¨ï¼Œå¹¶åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­å„ç»´æŠ¤ä¸€ä¸ªEventBusï¼Œä¸è¿‡è¿™æ ·å°±è¦è‡ªå·±å»ç»´æŠ¤registerå’Œunregisterçš„å…³ç³»ï¼Œæ¯”è¾ƒç¹çï¼Œè€Œä¸”è¿™ç§æƒ…å†µä¸‹é€šå¸¸ç”¨å¹¿æ’­ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œå¤§å®¶å¯ä»¥æ€è€ƒä¸€ä¸‹æœ‰æ²¡æœ‰æ›´ä¼˜çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h4 id="4-3-äº‹ä»¶ç¯è·¯é—®é¢˜"><a href="#4-3-äº‹ä»¶ç¯è·¯é—®é¢˜" class="headerlink" title="4.3 äº‹ä»¶ç¯è·¯é—®é¢˜"></a>4.3 äº‹ä»¶ç¯è·¯é—®é¢˜</h4><p>åœ¨ä½¿ç”¨EventBusæ—¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šæŠŠä¸¤ä¸ªæ¨¡å—ç›¸äº’ç›‘å¬ï¼Œæ¥è¾¾åˆ°ä¸€ä¸ªç›¸äº’å›è°ƒé€šä¿¡çš„ç›®çš„ã€‚ä½†è¿™æ ·ä¸€æ—¦å‡ºç°æ­»å¾ªç¯ï¼Œè€Œä¸”å¦‚æœæ²¡æœ‰ç›¸åº”çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¾ˆéš¾å®šä½é—®é¢˜ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨EventBusçš„æ¨¡å—ï¼Œå¦‚æœåœ¨å›è°ƒä¸Šæœ‰ç¯è·¯ï¼Œè€Œä¸”å›è°ƒæ–¹æ³•å¤æ‚åˆ°äº†ä¸€å®šç¨‹åº¦çš„è¯ï¼Œå°±è¦è€ƒè™‘æŠŠæ¥æ”¶äº‹ä»¶ä¸“é—¨å°è£…æˆä¸€ä¸ªå­æ¨¡å—ï¼ŒåŒæ—¶è€ƒè™‘é¿å…å‡ºç°äº‹ä»¶ç¯è·¯ã€‚</p>
<h3 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h3><p><code>EventBus</code>ä¸è®ºä»ä½¿ç”¨æ–¹å¼å’Œå®ç°æ–¹å¼ä¸Šéƒ½æ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„å¼€æºé¡¹ç›®ï¼Œå¯ä»¥è¯´æ˜¯ç›®å‰æ¶ˆæ¯é€šçŸ¥é‡Œæœ€å¥½ç”¨çš„é¡¹ç›®ã€‚ä½†æ˜¯ä¸šå†…å¯¹<code>EventBus</code>çš„ä¸»è¦äº‰è®ºç‚¹æ˜¯åœ¨äº<code>EventBus</code>ä½¿ç”¨åå°„ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œå®é™…ä¸Šåœ¨<code>EventBus</code>é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸ä»…å¯ä»¥ä½¿ç”¨æ³¨è§£å¤„ç†å™¨é¢„å¤„ç†è·å–è®¢é˜…ä¿¡æ¯ï¼Œ<code>EventBus</code>ä¹Ÿä¼šå°†è®¢é˜…è€…çš„æ–¹æ³•ç¼“å­˜åˆ°<code>METHOD_CACHE</code>é‡Œé¿å…é‡å¤æŸ¥æ‰¾ï¼Œæ‰€ä»¥åªæœ‰åœ¨æœ€å<code>invoke()</code>æ–¹æ³•çš„æ—¶å€™ä¼šæ¯”ç›´æ¥è°ƒç”¨å¤šå‡ºä¸€äº›æ€§èƒ½æŸè€—ã€‚</p>
<p>è€Œä¸”ç›¸æ¯”æ—§ç‰ˆçš„2.xï¼Œç°åœ¨æ–°ç‰ˆçš„EventBus 3.0ï¼Œè®¢é˜…è€…å·²ç»æ²¡æœ‰å›ºå®šçš„å¤„ç†äº‹ä»¶çš„æ–¹æ³•äº†ï¼Œ<code>onEvent</code>ã€<code>onEventMainThread</code>ã€<code>onEventBackgroundThread</code>ã€<code>onEventAsync</code>éƒ½æ²¡æœ‰äº†ï¼Œç°åœ¨æ”¯æŒå¤„ç†äº‹ä»¶çš„æ–¹æ³•åè‡ªå®šä¹‰ï¼Œä½†å¿…é¡»publicï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œç„¶åä½¿ç”¨æ³¨è§£<code>@Subscribe</code>æ¥æ ‡è®°è¯¥æ–¹æ³•ä¸ºå¤„ç†äº‹ä»¶çš„æ–¹æ³•ï¼ŒThreadModeå’Œpriorityä¹Ÿé€šè¿‡è¯¥æ³¨è§£æ¥å®šä¹‰ã€‚åœ¨subscriberMethodFinderä¸­ï¼Œé€šè¿‡åå°„çš„æ–¹å¼å¯»æ‰¾äº‹ä»¶æ–¹æ³•ã€‚ä½¿ç”¨æ³¨è§£ï¼Œç”¨èµ·æ¥æ‰æ›´çˆ½ã€‚</p>
<p>å½“ç„¶ï¼ŒEventBuså¹¶ä¸æ˜¯é‡æ„ä»£ç çš„å”¯ä¸€ä¹‹é€‰ã€‚ä½œä¸ºè§‚å¯Ÿè€…æ¨¡å¼çš„â€œåŒé—¨å¸ˆå…„å¼Ÿâ€â€”â€”RxJavaï¼Œä½œä¸ºåŠŸèƒ½æ›´ä¸ºå¼ºå¤§çš„å“åº”å¼ç¼–ç¨‹æ¡†æ¶ï¼Œå¯ä»¥è½»æ¾å®ç°EventBusçš„äº‹ä»¶æ€»çº¿åŠŸèƒ½ï¼ˆ<a href="http://www.jianshu.com/p/ca090f6e2fe2" target="_blank" rel="external">RxBus</a>ï¼‰ã€‚ä½†æ¯•ç«Ÿå¤§å‹é¡¹ç›®è¦æ¥å…¥RxJavaçš„æˆæœ¬é«˜ï¼Œå¤æ‚çš„æ“ä½œç¬¦éœ€è¦å¼€å‘è€…æŠ•å…¥æ›´å¤šçš„æ—¶é—´å»å­¦ä¹ ã€‚æ‰€ä»¥æƒ³åœ¨æˆç†Ÿçš„é¡¹ç›®ä¸­å¿«é€Ÿåœ°é‡æ„ã€è§£è€¦æ¨¡å—ï¼ŒEventBusä¾æ—§æ˜¯æˆ‘ä»¬çš„ä¸äºŒä¹‹é€‰ã€‚</p>
<hr>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul>
<li><a href="http://androiddevblog.com/eventbus-3-droidcon/" target="_blank" rel="external">Markus Junginger - EventBus 3 beta announced at droidcon</a></li>
<li><a href="https://segmentfault.com/a/1190000005089229" target="_blank" rel="external">è€å¸æœºæ•™ä½  â€œé£™â€ EventBus 3</a> -  <a href="https://segmentfault.com/u/tencentbugly" target="_blank" rel="external"><strong>è…¾è®¯Bugly</strong></a></li>
<li><a href="https://kymjs.com/code/2015/12/12/01/" target="_blank" rel="external">EventBusæºç ç ”è¯»(ä¸Š)</a>ï¼Œ<a href="https://www.kymjs.com/code/2015/12/13/01/" target="_blank" rel="external">(ä¸­)</a>ï¼Œ<a href="https://kymjs.com/code/2015/12/16/01/" target="_blank" rel="external">(ä¸‹)</a> - kymjså¼ æ¶›</li>
<li><a href="http://yydcdut.com/2016/03/07/eventbus3-code-analyse/" target="_blank" rel="external">EventBus3.0æºç è§£æ</a> - yydcdut</li>
<li><a href="http://skykai521.github.io/2016/02/20/EventBus-3-0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="external">EventBus 3.0 æºä»£ç åˆ†æ</a> - Skykai</li>
<li><a href="http://a.codekk.com/detail/Android/Trinea/EventBus%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" target="_blank" rel="external">EventBus æºç è§£æ</a> - codeKK</li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="../../../../categories/æºç åˆ†æ/">æºç åˆ†æ</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../../../tags/æºç åˆ†æ/">æºç åˆ†æ</a></li></ul>

      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: 'å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæ ‡é¢˜
  btnText: 'æ‰“èµæ”¯æŒ', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæŒ‰é’®æ–‡å­—
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/WeChanQR.png',
  alipayImage: 'https://raw.githubusercontent.com/iTimeTraveler/iTimeTraveler.github.io/site/source/about/donate/images/AliPayQR.jpg'
});
</script>
      
            
      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../../../10/05/ã€Androidã€‘æºç åˆ†æ - IntentServiceæœºåˆ¶/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
      <div class="article-nav-title">
        
          ã€Androidã€‘æºç åˆ†æ - IntentServiceæœºåˆ¶
        
      </div>
    </a>
  
  
    <a href="../../20/ã€Javaã€‘try-catch-finallyè¯­å¥ä¸­returnçš„æ‰§è¡Œé¡ºåºæ€è€ƒ/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
      <div class="article-nav-title">ã€Javaã€‘try-catch-finallyè¯­å¥ä¸­returnçš„æ‰§è¡Œé¡ºåºæ€è€ƒ</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    
      <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ¦‚è¿°"><span class="nav-number">1.</span> <span class="nav-text">æ¦‚è¿°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸€ã€ä½¿ç”¨EventBus"><span class="nav-number">2.</span> <span class="nav-text">ä¸€ã€ä½¿ç”¨EventBus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-åˆå§‹åŒ–"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-å®šä¹‰äº‹ä»¶"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 å®šä¹‰äº‹ä»¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-ç›‘å¬äº‹ä»¶"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 ç›‘å¬äº‹ä»¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-å‘é€äº‹ä»¶"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 å‘é€äº‹ä»¶</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#äºŒã€EventBusæºç è·Ÿè¸ª"><span class="nav-number">3.</span> <span class="nav-text">äºŒã€EventBusæºç è·Ÿè¸ª</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-åˆ›å»ºEventBuså¯¹è±¡"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 åˆ›å»ºEventBuså¯¹è±¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-æ³¨å†Œä¸è®¢é˜…Register"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 æ³¨å†Œä¸è®¢é˜…Register</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-å‘é€äº‹ä»¶Post"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 å‘é€äº‹ä»¶Post</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-è§£é™¤æ³¨å†ŒUnregister"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 è§£é™¤æ³¨å†ŒUnregister</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸‰ã€EventBusåŸç†åˆ†æ"><span class="nav-number">4.</span> <span class="nav-text">ä¸‰ã€EventBusåŸç†åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-æ ¸å¿ƒæ¶æ„"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 æ ¸å¿ƒæ¶æ„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-register"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 register</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-post"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 post</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-unregister"><span class="nav-number">4.4.</span> <span class="nav-text">3.4 unregister</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å››ã€ç¼ºç‚¹ä¸é—®é¢˜"><span class="nav-number">5.</span> <span class="nav-text">å››ã€ç¼ºç‚¹ä¸é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-æ··æ·†é—®é¢˜"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 æ··æ·†é—®é¢˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-è·¨è¿›ç¨‹é—®é¢˜"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 è·¨è¿›ç¨‹é—®é¢˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-äº‹ä»¶ç¯è·¯é—®é¢˜"><span class="nav-number">5.3.</span> <span class="nav-text">4.3 äº‹ä»¶ç¯è·¯é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#äº”ã€æ€»ç»“"><span class="nav-number">6.</span> <span class="nav-text">äº”ã€æ€»ç»“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‚è€ƒèµ„æ–™"><span class="nav-number">7.</span> <span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2017 iTimeTraveler All Rights Reserved.
          
            <span id="busuanzi_container_site_uv">
              æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡  
              æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

<!-- Custome JS -->
<script src="../../../../js/my.js"></script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../funnysite" class="mobile-nav-link">é…·ç«™</a>
  
    <a href="../../../../collection" class="mobile-nav-link">æ”¶è—</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
    <a href="../../../../mybooks" class="mobile-nav-link">ğŸ</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>
<script src="../../../../js/bootstrap.js"></script>
<script src="../../../../js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
